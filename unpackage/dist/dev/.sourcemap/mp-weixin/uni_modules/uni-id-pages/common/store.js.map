{"version":3,"file":"store.js","sources":["uni_modules/uni-id-pages/common/store.js"],"sourcesContent":["import pagesJson from '@/pages.json'\r\nimport config from '@/uni_modules/uni-id-pages/config.js'\r\n\r\nconst uniIdCo = uniCloud.importObject(\"uni-id-co\")\r\nconst db = uniCloud.database();\r\nconst usersTable = db.collection('uni-id-users')\r\n\r\nlet hostUserInfo = uni.getStorageSync('uni-id-pages-userInfo')||{}\r\n// console.log( hostUserInfo);\r\nconst data = {\r\n\tuserInfo: hostUserInfo,\r\n\thasLogin: Object.keys(hostUserInfo).length != 0\r\n}\r\n\r\n// console.log('data', data);\r\n// 定义 mutations, 修改属性\r\nexport const mutations = {\r\n\t// data不为空，表示传递要更新的值(注意不是覆盖是合并),什么也不传时，直接查库获取更新\r\n\tasync updateUserInfo(data = false) {\r\n\t\tif (data) {\r\n\t\t\tusersTable.where('_id==$env.uid').update(data).then(e => {\r\n\t\t\t\t// console.log(e);\r\n\t\t\t\tif (e.result.updated) {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"更新成功\",\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\tduration: 3000\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.setUserInfo(data)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\ttitle: \"没有改变\",\r\n\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\tduration: 3000\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t})\r\n\r\n\t\t} else {\r\n\t\t\tconst uniIdCo = uniCloud.importObject(\"uni-id-co\", {\r\n\t\t\t\tcustomUI: true\r\n\t\t\t})\r\n\t\t\ttry {\r\n\t\t\t\tlet res = await usersTable.where(\"'_id' == $cloudEnv_uid\")\r\n\t\t\t\t\t.field('mobile,nickname,username,email,avatar_file')\r\n\t\t\t\t\t.get()\r\n\r\n\t\t\t\tconst realNameRes = await uniIdCo.getRealNameInfo()\r\n\r\n\t\t\t\t// console.log('fromDbData',res.result.data);\r\n\t\t\t\tthis.setUserInfo({\r\n\t\t\t\t\t...res.result.data[0],\r\n\t\t\t\t\trealNameAuth: realNameRes\r\n\t\t\t\t})\r\n\t\t\t} catch (e) {\r\n\t\t\t\tthis.setUserInfo({},{cover:true})\r\n\t\t\t\tconsole.error(e.message, e.errCode);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tasync setUserInfo(data, {cover}={cover:false}) {\r\n\t\t// console.log('set-userInfo', data);\r\n\t\tlet userInfo = cover?data:Object.assign(store.userInfo,data)\r\n\t\tstore.userInfo = Object.assign({},userInfo)\r\n\t\tstore.hasLogin = Object.keys(store.userInfo).length != 0\r\n\t\t// console.log('store.userInfo', store.userInfo);\r\n\t\tuni.setStorageSync('uni-id-pages-userInfo', store.userInfo)\r\n\t\treturn data\r\n\t},\r\n\tasync logout() {\r\n\t\t// 1. 已经过期就不需要调用服务端的注销接口\t2.即使调用注销接口失败，不能阻塞客户端\r\n\t\tif(uniCloud.getCurrentUserInfo().tokenExpired > Date.now()){\r\n\t\t\ttry{\r\n\t\t\t\tawait uniIdCo.logout()\r\n\t\t\t}catch(e){\r\n\t\t\t\tconsole.error(e);\r\n\t\t\t}\r\n\t\t}\r\n\t\tuni.removeStorageSync('uni_id_token');\r\n\t\tuni.setStorageSync('uni_id_token_expired', 0)\r\n\t\tuni.redirectTo({\r\n\t\t\turl: `/${pagesJson.uniIdRouter && pagesJson.uniIdRouter.loginPage ? pagesJson.uniIdRouter.loginPage: 'uni_modules/uni-id-pages/pages/login/login-withoutpwd'}`,\r\n\t\t});\r\n\t\tuni.$emit('uni-id-pages-logout')\r\n\t\tthis.setUserInfo({},{cover:true})\r\n\t},\r\n\r\n\tloginBack (e = {}) {\r\n\t\tconst {uniIdRedirectUrl = ''} = e\r\n\t\tlet delta = 0; //判断需要返回几层\r\n\t\tlet pages = getCurrentPages();\r\n\t\t// console.log(pages);\r\n\t\tpages.forEach((page, index) => {\r\n\t\t\tif (pages[pages.length - index - 1].route.split('/')[3] == 'login') {\r\n\t\t\t\tdelta++\r\n\t\t\t}\r\n\t\t})\r\n\t\t// console.log('判断需要返回几层:', delta);\r\n\t\tif (uniIdRedirectUrl) {\r\n\t\t\treturn uni.redirectTo({\r\n\t\t\t\turl: uniIdRedirectUrl,\r\n\t\t\t\tfail: (err1) => {\r\n\t\t\t\t\tuni.switchTab({\r\n\t\t\t\t\t\turl:uniIdRedirectUrl,\r\n\t\t\t\t\t\tfail: (err2) => {\r\n\t\t\t\t\t\t\tconsole.log(err1,err2)\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\t\t// #ifdef H5\r\n\t\tif (e.loginType == 'weixin') {\r\n\t\t\t// console.log('window.history', window.history);\r\n\t\t\treturn window.history.go(-3)\r\n\t\t}\r\n\t\t// #endif\r\n\r\n\t\tif (delta) {\r\n\t\t\tconst page = pagesJson.pages[0]\r\n\t\t\treturn uni.reLaunch({\r\n\t\t\t\turl: `/${page.path}`\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tuni.navigateBack({\r\n\t\t\tdelta\r\n\t\t})\r\n\t},\r\n\tloginSuccess(e = {}){\r\n\t\tconst {\r\n\t\t\tshowToast = true, toastText = '登录成功', autoBack = true, uniIdRedirectUrl = '', passwordConfirmed\r\n\t\t} = e\r\n\t\t// console.log({toastText,autoBack});\r\n\t\tif (showToast) {\r\n\t\t\tuni.showToast({\r\n\t\t\t\ttitle: toastText,\r\n\t\t\t\ticon: 'none',\r\n\t\t\t\tduration: 3000\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.updateUserInfo()\r\n\r\n\t\tuni.$emit('uni-id-pages-login-success')\r\n\r\n\t\tif (config.setPasswordAfterLogin && !passwordConfirmed) {\r\n\t\t\treturn uni.redirectTo({\r\n\t\t\t\turl: uniIdRedirectUrl ? `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${uniIdRedirectUrl}&loginType=${e.loginType}`: `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,\r\n\t\t\t\tfail: (err) => {\r\n\t\t\t\t\tconsole.log(err)\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tif (autoBack) {\r\n\t\t\tthis.loginBack({uniIdRedirectUrl})\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\n// #ifdef VUE2\r\nimport Vue from 'vue'\r\n// 通过Vue.observable创建一个可响应的对象\r\nexport const store = Vue.observable(data)\r\n// #endif\r\n\r\n// #ifdef VUE3\r\nimport {\r\n\treactive\r\n} from 'vue'\r\n// 通过Vue.observable创建一个可响应的对象\r\nexport const store = reactive(data)\r\n// #endif\r\n"],"names":["uniIdCo","uniCloud","db","usersTable","hostUserInfo","uni","data","mutations","e","res","realNameRes","cover","userInfo","store","pagesJson","uniIdRedirectUrl","delta","pages","page","index","err1","err2","showToast","toastText","autoBack","passwordConfirmed","config","err","reactive"],"mappings":"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"}