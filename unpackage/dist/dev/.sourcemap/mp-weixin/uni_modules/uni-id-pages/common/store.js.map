{"version":3,"file":"store.js","sources":["uni_modules/uni-id-pages/common/store.js"],"sourcesContent":["import pagesJson from '@/pages.json'\nimport config from '@/uni_modules/uni-id-pages/config.js'\n\nconst uniIdCo = uniCloud.importObject(\"uni-id-co\")\nconst db = uniCloud.database();\nconst usersTable = db.collection('uni-id-users')\n\nlet hostUserInfo = uni.getStorageSync('uni-id-pages-userInfo')||{}\n// console.log( hostUserInfo);\nconst data = {\n\tuserInfo: hostUserInfo,\n\thasLogin: Object.keys(hostUserInfo).length != 0\n}\n\n// console.log('data', data);\n// 定义 mutations, 修改属性\nexport const mutations = {\n\t// data不为空，表示传递要更新的值(注意不是覆盖是合并),什么也不传时，直接查库获取更新\n\tasync updateUserInfo(data = false) {\n\t\tif (data) {\n\t\t\tusersTable.where('_id==$env.uid').update(data).then(e => {\n\t\t\t\t// console.log(e);\n\t\t\t\tif (e.result.updated) {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: \"更新成功\",\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 3000\n\t\t\t\t\t});\n\t\t\t\t\tthis.setUserInfo(data)\n\t\t\t\t} else {\n\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\ttitle: \"没有改变\",\n\t\t\t\t\t\ticon: 'none',\n\t\t\t\t\t\tduration: 3000\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\n\t\t} else {\n\t\t\tconst uniIdCo = uniCloud.importObject(\"uni-id-co\", {\n\t\t\t\tcustomUI: true\n\t\t\t})\n\t\t\ttry {\n\t\t\t\tlet res = await usersTable.where(\"'_id' == $cloudEnv_uid\")\n\t\t\t\t\t.field('mobile,nickname,username,email,avatar_file')\n\t\t\t\t\t.get()\n\n\t\t\t\tconst realNameRes = await uniIdCo.getRealNameInfo()\n\n\t\t\t\t// console.log('fromDbData',res.result.data);\n\t\t\t\tthis.setUserInfo({\n\t\t\t\t\t...res.result.data[0],\n\t\t\t\t\trealNameAuth: realNameRes\n\t\t\t\t})\n\t\t\t} catch (e) {\n\t\t\t\tthis.setUserInfo({},{cover:true})\n\t\t\t\tconsole.error(e.message, e.errCode);\n\t\t\t}\n\t\t}\n\t},\n\tasync setUserInfo(data, {cover}={cover:false}) {\n\t\t// console.log('set-userInfo', data);\n\t\tlet userInfo = cover?data:Object.assign(store.userInfo,data)\n\t\tstore.userInfo = Object.assign({},userInfo)\n\t\tstore.hasLogin = Object.keys(store.userInfo).length != 0\n\t\t// console.log('store.userInfo', store.userInfo);\n\t\tuni.setStorageSync('uni-id-pages-userInfo', store.userInfo)\n\t\treturn data\n\t},\n\tasync logout() {\n\t\t// 1. 已经过期就不需要调用服务端的注销接口\t2.即使调用注销接口失败，不能阻塞客户端\n\t\tif(uniCloud.getCurrentUserInfo().tokenExpired > Date.now()){\n\t\t\ttry{\n\t\t\t\tawait uniIdCo.logout()\n\t\t\t}catch(e){\n\t\t\t\tconsole.error(e);\n\t\t\t}\n\t\t}\n\t\tuni.removeStorageSync('uni_id_token');\n\t\tuni.setStorageSync('uni_id_token_expired', 0)\n\t\tuni.redirectTo({\n\t\t\turl: `/${pagesJson.uniIdRouter && pagesJson.uniIdRouter.loginPage ? pagesJson.uniIdRouter.loginPage: 'uni_modules/uni-id-pages/pages/login/login-withoutpwd'}`,\n\t\t});\n\t\tuni.$emit('uni-id-pages-logout')\n\t\tthis.setUserInfo({},{cover:true})\n\t},\n\n\tloginBack (e = {}) {\n\t\tconst {uniIdRedirectUrl = ''} = e\n\t\tlet delta = 0; //判断需要返回几层\n\t\tlet pages = getCurrentPages();\n\t\t// console.log(pages);\n\t\tpages.forEach((page, index) => {\n\t\t\tif (pages[pages.length - index - 1].route.split('/')[3] == 'login') {\n\t\t\t\tdelta++\n\t\t\t}\n\t\t})\n\t\t// console.log('判断需要返回几层:', delta);\n\t\tif (uniIdRedirectUrl) {\n\t\t\treturn uni.redirectTo({\n\t\t\t\turl: uniIdRedirectUrl,\n\t\t\t\tfail: (err1) => {\n\t\t\t\t\tuni.switchTab({\n\t\t\t\t\t\turl:uniIdRedirectUrl,\n\t\t\t\t\t\tfail: (err2) => {\n\t\t\t\t\t\t\tconsole.log(err1,err2)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t\t// #ifdef H5\n\t\tif (e.loginType == 'weixin') {\n\t\t\t// console.log('window.history', window.history);\n\t\t\treturn window.history.go(-3)\n\t\t}\n\t\t// #endif\n\n\t\tif (delta) {\n\t\t\tconst page = pagesJson.pages[0]\n\t\t\treturn uni.reLaunch({\n\t\t\t\turl: `/${page.path}`\n\t\t\t})\n\t\t}\n\n\t\tuni.navigateBack({\n\t\t\tdelta\n\t\t})\n\t},\n\tloginSuccess(e = {}){\n\t\tconst {\n\t\t\tshowToast = true, toastText = '登录成功', autoBack = true, uniIdRedirectUrl = '', passwordConfirmed\n\t\t} = e\n\t\t// console.log({toastText,autoBack});\n\t\tif (showToast) {\n\t\t\tuni.showToast({\n\t\t\t\ttitle: toastText,\n\t\t\t\ticon: 'none',\n\t\t\t\tduration: 3000\n\t\t\t});\n\t\t}\n\t\tthis.updateUserInfo()\n\n\t\tuni.$emit('uni-id-pages-login-success')\n\n\t\tif (config.setPasswordAfterLogin && !passwordConfirmed) {\n\t\t\treturn uni.redirectTo({\n\t\t\t\turl: uniIdRedirectUrl ? `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${uniIdRedirectUrl}&loginType=${e.loginType}`: `/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${e.loginType}`,\n\t\t\t\tfail: (err) => {\n\t\t\t\t\tconsole.log(err)\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\tif (autoBack) {\n\t\t\tthis.loginBack({uniIdRedirectUrl})\n\t\t}\n\t}\n\n}\n\n// #ifdef VUE2\nimport Vue from 'vue'\n// 通过Vue.observable创建一个可响应的对象\nexport const store = Vue.observable(data)\n// #endif\n\n// #ifdef VUE3\nimport {\n\treactive\n} from 'vue'\n// 通过Vue.observable创建一个可响应的对象\nexport const store = reactive(data)\n// #endif\n"],"names":["uniCloud","uni","data","uniIdCo","pagesJson","config","reactive"],"mappings":"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"}