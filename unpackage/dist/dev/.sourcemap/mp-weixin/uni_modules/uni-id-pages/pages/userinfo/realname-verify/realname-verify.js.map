{"version":3,"file":"realname-verify.js","sources":["uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify.vue","uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify.vue?type=page"],"sourcesContent":["<template>\n  <view>\n    <template v-if=\"isCertify\">\n      <uni-list>\n        <uni-list-item class=\"item\" title=\"姓名\" :rightText=\"userInfo.realNameAuth.realName\"></uni-list-item>\n        <uni-list-item class=\"item\" title=\"身份证号码\" :rightText=\"userInfo.realNameAuth.identity\"></uni-list-item>\n      </uni-list>\n    </template>\n    <template v-else>\n      <view class=\"uni-content\">\n        <template v-if=\"verifyFail\">\n          <view class=\"face-icon\">\n            <image src=\"./face-verify-icon.svg\" class=\"face-icon-image\" />\n          </view>\n          <view class=\"error-title\">{{verifyFailTitle}}</view>\n          <view class=\"error-description\">{{verifyFailContent}}</view>\n          <button type=\"primary\" @click=\"retry\" v-if=\"verifyFailCode !== 10013\">重新开始验证</button>\n          <button type=\"primary\" @click=\"retry\" v-else>返回</button>\n          <view class=\"dev-tip\" v-if=\"isDev\">请在控制台查看详细错误（此提示仅在开发环境展示）</view>\n        </template>\n        <template v-else>\n          <text class=\"title\">实名认证</text>\n          <uni-forms>\n            <uni-forms-item name=\"realName\">\n              <uni-easyinput placeholder=\"姓名\" class=\"input-box\" v-model=\"realName\" :clearable=\"false\">\n              </uni-easyinput>\n            </uni-forms-item>\n            <uni-forms-item name=\"idCard\">\n              <uni-easyinput placeholder=\"身份证号码\" class=\"input-box\" v-model=\"idCard\" :clearable=\"false\">\n              </uni-easyinput>\n            </uni-forms-item>\n          </uni-forms>\n          <uni-id-pages-agreements scope=\"realNameVerify\" ref=\"agreements\" style=\"margin-bottom: 20px;\">\n          </uni-id-pages-agreements>\n          <button type=\"primary\" :disabled=\"!certifyIdNext\" @click=\"getCertifyId\">确定</button>\n        </template>\n      </view>\n    </template>\n  </view>\n</template>\n\n<script>\nimport checkIdCard from '@/uni_modules/uni-id-pages/common/check-id-card.js';\nimport mixin from '@/uni_modules/uni-id-pages/common/login-page.mixin.js';\n\nimport {\n  store,\n  mutations\n} from '@/uni_modules/uni-id-pages/common/store.js'\n\nconst uniIdCo = uniCloud.importObject('uni-id-co')\nconst tempFrvInfoKey = 'uni-id-pages-temp-frv'\nexport default {\n  mixins: [mixin],\n  data() {\n    return {\n      realName: '',\n      idCard: '',\n      certifyId: '',\n      verifyFail: false,\n      verifyFailCode: 0,\n      verifyFailTitle: '',\n      verifyFailContent: ''\n    }\n  },\n  computed: {\n    userInfo() {\n      return store.userInfo\n    },\n    certifyIdNext() {\n      return Boolean(this.realName) && Boolean(this.idCard) && (this.needAgreements && this.agree)\n    },\n    isCertify() {\n      return this.userInfo.realNameAuth && this.userInfo.realNameAuth.authStatus === 2\n    },\n    isDev() {\n      return process.env.NODE_ENV === 'development'\n    }\n  },\n  onLoad() {\n    const tempFrvInfo = uni.getStorageSync(tempFrvInfoKey);\n    if (tempFrvInfo) {\n      this.realName = tempFrvInfo.realName\n      this.idCard = tempFrvInfo.idCard\n    }\n  },\n  methods: {\n    async getCertifyId() {\n      if (!this.certifyIdNext) return\n\n      // #ifndef APP\n      return uni.showModal({\n        content: \"暂不支持实名认证\",\n        showCancel: false\n      })\n      // #endif\n\n      if (!checkIdCard(this.idCard)) {\n        uni.showToast({\n          title: \"身份证不合法\",\n          icon: \"none\"\n        })\n        return\n      }\n\n      if (\n          typeof this.realName !== 'string' ||\n          this.realName.length < 2 ||\n          !/^[\\u4e00-\\u9fa5]{1,10}(·?[\\u4e00-\\u9fa5]{1,10}){0,5}$/.test(this.realName)\n      ) {\n        uni.showToast({\n          title: \"姓名只能是汉字\",\n          icon: \"none\"\n        })\n        return\n      }\n\n      uni.setStorage({\n        key: tempFrvInfoKey,\n        data: {\n          realName: this.realName,\n          idCard: this.idCard\n        }\n      });\n\n      const metaInfo = uni.getFacialRecognitionMetaInfo()\n\n      const res = await uniIdCo.getFrvCertifyId({\n        realName: this.realName,\n        idCard: this.idCard,\n        metaInfo\n      })\n\n      this.certifyId = res.certifyId\n\n      this.startFacialRecognitionVerify()\n    },\n    startFacialRecognitionVerify() {\n\n      // #ifdef APP\n      uni.startFacialRecognitionVerify({\n        certifyId: this.certifyId,\n        progressBarColor: \"#2979ff\",\n        success: () => {\n          this.verifyFail = false\n          this.getFrvAuthResult()\n        },\n        fail: (e) => {\n          let title = \"验证失败\"\n          let content\n\n          console.log(\n              `[frv-debug] certifyId auth error: certifyId -> ${this.certifyId}, error -> ${JSON.stringify(e, null, 4)}`\n          )\n\n          switch (e.errCode) {\n            case 10001:\n              content = '认证ID为空'\n              break\n            case 10010:\n              title = '刷脸异常'\n              content = e.cause.message || '错误代码: 10010'\n              break\n            case 10011:\n              title = '验证中断'\n              content = e.cause.message || '错误代码: 10011'\n              break\n            case 10012:\n              content = '网络异常'\n              break\n            case 10013:\n              this.verifyFailCode = e.errCode\n              this.verifyFailContent = e.cause.message || '错误代码: 10013'\n              this.getFrvAuthResult()\n\n              console.log(\n                  `[frv-debug] 刷脸失败, certifyId -> ${this.certifyId}, 如在开发环境请检查用户的姓名、身份证号与刷脸用户是否为同一用户。如遇到认证ID已使用请检查opendb-frv-logs表中certifyId状态`\n              )\n              return\n            case 10020:\n              content = '设备设置时间异常'\n              break\n            default:\n              title = ''\n              content = `验证未知错误 (${e.errCode})`\n              break\n          }\n\n          this.verifyFail = true\n          this.verifyFailCode = e.errCode\n          this.verifyFailTitle = title\n          this.verifyFailContent = content\n        }\n      })\n      // #endif\n    },\n    async getFrvAuthResult() {\n      const uniIdCo = uniCloud.importObject('uni-id-co', {\n        customUI: true\n      })\n      try {\n        uni.showLoading({\n          title: \"验证中...\",\n          mask: false\n        })\n        const res = await uniIdCo.getFrvAuthResult({\n          certifyId: this.certifyId\n        })\n\n        const {\n          errCode,\n          ...rest\n        } = res\n\n        if (this.verifyFailContent) {\n          console.log(`[frv-debug] 客户端刷脸失败，由实人认证服务查询具体原因，原因：${this.verifyFailContent}`)\n        }\n\n        uni.showModal({\n          content: \"实名认证成功\",\n          showCancel: false,\n          success: () => {\n            mutations.setUserInfo({\n              realNameAuth: rest\n            })\n            this.verifyFail = false\n          }\n        })\n\n        uni.removeStorage({\n          key: tempFrvInfoKey\n        })\n      } catch (e) {\n        this.verifyFail = true\n        this.verifyFailTitle = e.errMsg\n        console.error(JSON.stringify(e));\n      } finally {\n        uni.hideLoading()\n      }\n    },\n    retry() {\n      if (this.verifyFailCode !== 10013) {\n        this.getCertifyId()\n      } else {\n        this.verifyFail = false\n      }\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\">\n@import \"@/uni_modules/uni-id-pages/common/login-page.scss\";\n\n.checkbox-box,\n.uni-label-pointer {\n  align-items: center;\n  display: flex;\n  flex-direction: row;\n}\n\n.item {\n  flex-direction: row;\n}\n\n.text {\n  line-height: 26px;\n}\n\n.checkbox-box ::v-deep .uni-checkbox-input {\n  border-radius: 100%;\n}\n\n.checkbox-box ::v-deep .uni-checkbox-input.uni-checkbox-input-checked {\n  border-color: $uni-color-primary;\n  color: #FFFFFF !important;\n  background-color: $uni-color-primary;\n}\n\n.agreements {\n  margin-bottom: 20px;\n}\n\n.face-icon {\n  width: 100px;\n  height: 100px;\n  margin: 50px auto 30px;\n}\n\n.face-icon-image {\n  width: 100%;\n  height: 100%;\n  display: block;\n}\n\n.error-title {\n  font-size: 18px;\n  text-align: center;\n  font-weight: bold;\n}\n\n.error-description {\n  font-size: 13px;\n  color: #999999;\n  margin: 10px 0 20px;\n  text-align: center;\n}\n\n.dev-tip {\n  margin-top: 20px;\n  font-size: 13px;\n  color: #999;\n  text-align: center;\n}\n</style>\n","import MiniProgramPage from '/Users/zhouzhongwei/Documents/HBuilderProjects/be-crm-main/uni_modules/uni-id-pages/pages/userinfo/realname-verify/realname-verify.vue'\nwx.createPage(MiniProgramPage)"],"names":["uniCloud","mixin","store","uni","uniIdCo","mutations"],"mappings":";;;;;AAkDgBA,cAAAA,GAAS,aAAa,WAAW;AACjD,MAAM,iBAAiB;AACvB,MAAK,YAAU;AAAA,EACb,QAAQ,CAACC,8CAAAA,KAAK;AAAA,EACd,OAAO;AACE,WAAA;AAAA,MACL,UAAU;AAAA,MACV,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,YAAY;AAAA,MACZ,gBAAgB;AAAA,MAChB,iBAAiB;AAAA,MACjB,mBAAmB;AAAA,IAAA;AAAA,EAEvB;AAAA,EACA,UAAU;AAAA,IACR,WAAW;AACT,aAAOC,oCAAAA,MAAM;AAAA,IACf;AAAA,IACA,gBAAgB;AACP,aAAA,QAAQ,KAAK,QAAQ,KAAK,QAAQ,KAAK,MAAM,MAAM,KAAK,kBAAkB,KAAK;AAAA,IACxF;AAAA,IACA,YAAY;AACV,aAAO,KAAK,SAAS,gBAAgB,KAAK,SAAS,aAAa,eAAe;AAAA,IACjF;AAAA,IACA,QAAQ;AACC,aAAA;AAAA,IACT;AAAA,EACF;AAAA,EACA,SAAS;AACD,UAAA,cAAcC,cAAAA,MAAI,eAAe,cAAc;AACrD,QAAI,aAAa;AACf,WAAK,WAAW,YAAY;AAC5B,WAAK,SAAS,YAAY;AAAA,IAC5B;AAAA,EACF;AAAA,EACA,SAAS;AAAA,IACP,MAAM,eAAe;AACnB,UAAI,CAAC,KAAK;AAAe;AAGzB,aAAOA,cAAAA,MAAI,UAAU;AAAA,QACnB,SAAS;AAAA,QACT,YAAY;AAAA,MAAA,CACb;AAAA,IA0CH;AAAA,IACA,+BAA+B;AAAA,IA0D/B;AAAA,IACA,MAAM,mBAAmB;AACjBC,YAAAA,WAAUJ,cAAAA,GAAS,aAAa,aAAa;AAAA,QACjD,UAAU;AAAA,MAAA,CACX;AACG,UAAA;AACFG,sBAAAA,MAAI,YAAY;AAAA,UACd,OAAO;AAAA,UACP,MAAM;AAAA,QAAA,CACP;AACK,cAAA,MAAM,MAAMC,SAAQ,iBAAiB;AAAA,UACzC,WAAW,KAAK;AAAA,QAAA,CACjB;AAEK,cAAA;AAAA,UACJ;AAAA,UACA,GAAG;AAAA,QACD,IAAA;AAEJ,YAAI,KAAK,mBAAmB;AAC1BD,iIAAY,wCAAwC,KAAK,iBAAiB,EAAE;AAAA,QAC9E;AAEAA,sBAAAA,MAAI,UAAU;AAAA,UACZ,SAAS;AAAA,UACT,YAAY;AAAA,UACZ,SAAS,MAAM;AACbE,gDAAAA,UAAU,YAAY;AAAA,cACpB,cAAc;AAAA,YAAA,CACf;AACD,iBAAK,aAAa;AAAA,UACpB;AAAA,QAAA,CACD;AAEDF,sBAAAA,MAAI,cAAc;AAAA,UAChB,KAAK;AAAA,QAAA,CACN;AAAA,eACM,GAAG;AACV,aAAK,aAAa;AAClB,aAAK,kBAAkB,EAAE;AACzBA,sBAAA,MAAc,MAAA,SAAA,sFAAA,KAAK,UAAU,CAAC,CAAC;AAAA,MAAA,UAC/B;AACAA,sBAAA,MAAI,YAAY;AAAA,MAClB;AAAA,IACF;AAAA,IACA,QAAQ;AACF,UAAA,KAAK,mBAAmB,OAAO;AACjC,aAAK,aAAa;AAAA,MAAA,OACb;AACL,aAAK,aAAa;AAAA,MACpB;AAAA,IACF;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvPA,GAAG,WAAW,eAAe;"}