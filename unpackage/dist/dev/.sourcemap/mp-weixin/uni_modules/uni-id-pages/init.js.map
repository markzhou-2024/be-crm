{"version":3,"file":"init.js","sources":["uni_modules/uni-id-pages/init.js"],"sourcesContent":["// 导入配置\nimport config from '@/uni_modules/uni-id-pages/config.js'\n// uni-id的云对象\nconst uniIdCo = uniCloud.importObject('uni-id-co', {\n  customUI: true\n})\n// 用户配置的登录方式、是否打开调试模式\nconst {\n  loginTypes,\n  debug\n} = config\n\nexport default async function () {\n  // 有打开调试模式的情况下\n  if (debug) {\n    // 1. 检查本地uni-id-pages中配置的登录方式，服务器端是否已经配置正确。否则提醒并引导去配置\n    // 调用云对象，获取服务端已正确配置的登录方式\n    const {\n      supportedLoginType\n    } = await uniIdCo.getSupportedLoginType()\n    console.log('supportedLoginType: ' + JSON.stringify(supportedLoginType))\n    // 登录方式，服务端和客户端的映射关系\n    const data = {\n      smsCode: 'mobile-code',\n      univerify: 'univerify',\n      username: 'username-password',\n      weixin: 'weixin',\n      qq: 'qq',\n      xiaomi: 'xiaomi',\n      sinaweibo: 'sinaweibo',\n      taobao: 'taobao',\n      facebook: 'facebook',\n      google: 'google',\n      alipay: 'alipay',\n      apple: 'apple',\n      weixinMobile: 'weixin'\n    }\n    // 遍历客户端配置的登录方式，与服务端比对。并在错误时抛出错误提示\n    const list = loginTypes.filter(type => !supportedLoginType.includes(data[type]))\n    if (list.length) {\n      console.error(\n\t\t\t\t`错误：前端启用的登录方式:${list.join('，')};没有在服务端完成配置。配置文件路径：\"/uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-id/config.json\"`\n      )\n    }\n  }\n\n  // #ifdef APP-PLUS\n  // 如果uni-id-pages配置的登录功能有一键登录，有则执行预登录（异步）\n  if (loginTypes.includes('univerify')) {\n    uni.preLogin({\n      provider: 'univerify',\n      complete: e => {\n        // console.log(e);\n      }\n    })\n  }\n  // #endif\n\n  // 3. 绑定clientDB错误事件\n  // clientDB对象\n  const db = uniCloud.database()\n  db.on('error', onDBError)\n  // clientDB的错误提示\n  function onDBError ({\n    code, // 错误码详见https://uniapp.dcloud.net.cn/uniCloud/clientdb?id=returnvalue\n    message\n  }) {\n    // console.error('onDBError', {code,message});\n  }\n  // 解绑clientDB错误事件\n  // db.off('error', onDBError)\n\n  // 4. 同步客户端push_clientid至device表\n  if (uniCloud.onRefreshToken) {\n    uniCloud.onRefreshToken(() => {\n      // console.log('onRefreshToken');\n      if (uni.getPushClientId) {\n        uni.getPushClientId({\n          success: async function (e) {\n            // console.log(e)\n            const pushClientId = e.cid\n            // console.log(pushClientId);\n            const res = await uniIdCo.setPushCid({\n              pushClientId\n            })\n            // console.log('getPushClientId', res);\n          },\n          fail (e) {\n            // console.log(e)\n          }\n        })\n      }\n    })\n  }\n}\n"],"names":["uniCloud","config","uni"],"mappings":";;;AAGA,MAAM,UAAUA,cAAAA,GAAS,aAAa,aAAa;AAAA,EACjD,UAAU;AACZ,CAAC;AAED,MAAM;AAAA,EACJ;AAAA,EACA;AACF,IAAIC,8BAAM;AAEK,eAAA,gBAAkB;AAE/B,MAAI,OAAO;AAGT,UAAM;AAAA,MACJ;AAAA,IACN,IAAQ,MAAM,QAAQ,sBAAuB;AACzCC,wBAAA,MAAA,OAAA,0CAAY,yBAAyB,KAAK,UAAU,kBAAkB,CAAC;AAEvE,UAAM,OAAO;AAAA,MACX,SAAS;AAAA,MACT,WAAW;AAAA,MACX,UAAU;AAAA,MACV,QAAQ;AAAA,MACR,IAAI;AAAA,MACJ,QAAQ;AAAA,MACR,WAAW;AAAA,MACX,QAAQ;AAAA,MACR,UAAU;AAAA,MACV,QAAQ;AAAA,MACR,QAAQ;AAAA,MACR,OAAO;AAAA,MACP,cAAc;AAAA,IACf;AAED,UAAM,OAAO,WAAW,OAAO,UAAQ,CAAC,mBAAmB,SAAS,KAAK,IAAI,CAAC,CAAC;AAC/E,QAAI,KAAK,QAAQ;AACfA,0BAAc;AAAA,QAAA;AAAA,QAAA;AAAA,QAChB,gBAAgB,KAAK,KAAK,GAAG,CAAC;AAAA,MAC3B;AAAA,IACF;AAAA,EACF;AAgBD,QAAM,KAAKF,cAAQ,GAAC,SAAU;AAC9B,KAAG,GAAG,SAAS,SAAS;AAExB,WAAS,UAAW;AAAA,IAClB;AAAA;AAAA,IACA;AAAA,EACJ,GAAK;AAAA,EAEF;AAKD,MAAIA,cAAAA,GAAS,gBAAgB;AAC3BA,kBAAQ,GAAC,eAAe,MAAM;AAE5B,UAAIE,cAAAA,MAAI,iBAAiB;AACvBA,sBAAAA,MAAI,gBAAgB;AAAA,UAClB,SAAS,eAAgB,GAAG;AAE1B,kBAAM,eAAe,EAAE;AAEX,kBAAM,QAAQ,WAAW;AAAA,cACnC;AAAA,YACd,CAAa;AAAA,UAEF;AAAA,UACD,KAAM,GAAG;AAAA,UAER;AAAA,QACX,CAAS;AAAA,MACF;AAAA,IACP,CAAK;AAAA,EACF;AACH;;"}