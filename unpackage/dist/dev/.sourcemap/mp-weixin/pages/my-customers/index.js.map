{"version":3,"file":"index.js","sources":["pages/my-customers/index.vue","../../../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvbXktY3VzdG9tZXJzL2luZGV4LnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"page\">\n    <view class=\"header\">\n      <view class=\"title\">ÂÆ¢Êà∑ÁÆ°ÁêÜ</view>\n\n      <view class=\"search\">\n        <text class=\"search-icon\">üîç</text>\n        <input\n          class=\"search-input\"\n          v-model=\"keyword\"\n          placeholder=\"ÊêúÁ¥¢ÂÆ¢Êà∑ÂßìÂêçÊàñÊâãÊú∫Âè∑\"\n          placeholder-style=\"color:#b9b9bd\"\n          confirm-type=\"search\"\n          @confirm=\"applyFilter(true)\"\n        />\n        <text v-if=\"keyword\" class=\"clear\" @tap=\"clearSearch\">‚úï</text>\n      </view>\n\n      <scroll-view class=\"tabs\" scroll-x enable-flex>\n        <view\n          v-for=\"t in tabs\"\n          :key=\"t.value\"\n          class=\"tab\"\n          :class=\"{ active: activeTab === t.value }\"\n          @tap=\"switchTab(t.value)\"\n        >{{ t.label }}</view>\n      </scroll-view>\n\n      <scroll-view class=\"shop-filter\" scroll-x enable-flex>\n        <view\n          v-for=\"opt in shopFilters\"\n          :key=\"opt.value\"\n          class=\"shop-pill\"\n          :class=\"{ active: activeShopId === opt.value }\"\n          @tap=\"switchShop(opt.value)\"\n        >{{ opt.label }}</view>\n      </scroll-view>\n    </view>\n\n    <scroll-view\n      class=\"list\"\n      scroll-y\n      :lower-threshold=\"80\"\n      @scrolltolower=\"loadMore\"\n      refresher-enabled\n      :refresher-triggered=\"refreshing\"\n      @refresherrefresh=\"onRefresh\"\n    >\n      <block v-for=\"c in visibleList\" :key=\"c._id\">\n        <view class=\"card\" @tap=\"openDetail(c)\" @longpress=\"onLongPress(c)\">\n          <view class=\"row-top\">\n            <image class=\"avatar\" :src=\"c.avatar || defaultAvatar\" mode=\"aspectFill\"></image>\n            <view class=\"base\">\n              <view class=\"name\">\n                <text>{{ c.name }}</text>\n                <text v-if=\"c.is_vip\" class=\"vip\">VIP</text>\n              </view>\n              <view class=\"phone\">\n                <text class=\"phone-icon\">üìû</text>\n                <text>{{ maskPhone(c.phone) }}</text>\n              </view>\n              <view class=\"store\" v-if=\"c.store_name\">\n                <text class=\"store-icon\">üè¨</text>\n                <text>{{ c.store_name }}</text>\n              </view>\n            </view>\n            <text class=\"arrow\">‚Ä∫</text>\n          </view>\n\n          <view class=\"row-bottom\">\n            <view class=\"meta\">\n              <text class=\"meta-icon\">üïí</text>\n              <text class=\"meta-gray\">‰∏äÊ¨°Âà∞Â∫ó</text>\n              <text class=\"meta-strong\">{{ c.last_visit_label || '-' }}</text>\n            </view>\n            <view class=\"spend\">\n              <text class=\"meta-icon gold\">Ôø•</text>\n              <text class=\"meta-gray\">Á¥ØËÆ°Ê∂àË¥π</text>\n              <text class=\"amount\">¬•{{ toAmount(c.total_spend) }}</text>\n            </view>\n          </view>\n        </view>\n      </block>\n\n      <view v-if=\"!visibleList.length && !loading && !refreshing\" class=\"empty\">\n        ÊöÇÊó†ÂÆ¢Êà∑\n      </view>\n      <view v-if=\"loading\" class=\"loading\">Âä†ËΩΩ‰∏≠...</view>\n      <view v-else-if=\"!hasMore && visibleList.length\" class=\"loading end\">Â∑≤Âà∞Â∫ï</view>\n    </scroll-view>\n\n    <view class=\"fab\" @tap=\"goCreate\">Ôºã</view>\n  </view>\n</template>\n\n<script>\n// @ts-nocheck\nimport { fetchCustomers, deleteCustomer as deleteCustomerApi } from '@/api/customers.js'\nimport { filterByStoreId } from '@/utils/customersStore.js'\nimport { loadShops } from '@/utils/shopsStore.js'\n\nexport default {\n  data() {\n    return {\n      defaultAvatar: 'https://cdn.uviewui.com/uview/album/1.jpg',\n      keyword: '',\n      activeTab: 'all',\n      tabs: [\n        { label: 'ÂÖ®ÈÉ®ÂÆ¢Êà∑', value: 'all' },\n        { label: 'VIPÂÆ¢Êà∑', value: 'vip' },\n        { label: 'Ê¥ªË∑ÉÂÆ¢Êà∑', value: 'active' }\n      ],\n      shops: [],\n      shopFilters: [],\n      activeShopId: '',\n      list: [],\n      filtered: [],\n      visibleList: [],\n      page: 1,\n      pageSize: 10,\n      hasMore: true,\n      loading: false,\n      refreshing: false\n    }\n  },\n  onLoad(query) {\n    this.activeShopId = (query && query.store_id) || ''\n    this.initShops()\n  },\n  onShow() {\n    this.initShops()\n    this.initData()\n  },\n  methods: {\n    initShops() {\n      const shops = loadShops([])\n      this.shops = shops\n      this.shopFilters = [\n        { label: 'ÂÖ®ÈÉ®Èó®Â∫ó', value: '' },\n        ...shops.map(s => ({ label: s.store_name || 'Êú™ÂëΩÂêçÈó®Â∫ó', value: s._id })),\n        { label: 'Êú™ÂàÜÈÖç', value: '_unassigned' }\n      ]\n    },\n    async initData() {\n      this.loading = true\n      try {\n        const list = await fetchCustomers()\n        this.decorate(list)\n        this.list = list\n        this.applyFilter(true)\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || 'Âä†ËΩΩÂ§±Ë¥•', icon: 'none' })\n      } finally {\n        this.loading = false\n      }\n    },\n    decorate(list) {\n      (list || []).forEach(item => {\n        const days = Number(item.last_visit_days)\n        if (isNaN(days)) {\n          item.last_visit_label = '-'\n        } else if (days === 0) {\n          item.last_visit_label = '‰ªäÂ§©'\n        } else if (days === 1) {\n          item.last_visit_label = 'Êò®Â§©'\n        } else if (days === 7) {\n          item.last_visit_label = '1Âë®Ââç'\n        } else {\n          item.last_visit_label = `${days}Â§©Ââç`\n        }\n      })\n    },\n    onRefresh() {\n      this.refreshing = true\n      setTimeout(() => {\n        this.initData()\n        this.refreshing = false\n      }, 400)\n    },\n    switchTab(value) {\n      this.activeTab = value\n      this.applyFilter(true)\n    },\n    switchShop(value) {\n      this.activeShopId = value\n      this.applyFilter(true)\n    },\n    clearSearch() {\n      this.keyword = ''\n      this.applyFilter(true)\n    },\n    applyFilter(resetPage = false) {\n      let list = this.list.slice()\n      if (this.activeTab === 'vip') {\n        list = list.filter(item => !!item.is_vip)\n      } else if (this.activeTab === 'active') {\n        list = list.filter(item => (item.last_visit_days || 0) <= 7)\n      }\n      const kw = (this.keyword || '').trim()\n      if (kw) {\n        list = list.filter(item => {\n          const name = item.name || ''\n          const phone = item.phone || ''\n          return name.indexOf(kw) >= 0 || phone.indexOf(kw) >= 0\n        })\n      }\n      list = filterByStoreId(list, this.activeShopId)\n      this.filtered = list\n      if (resetPage) {\n        this.page = 1\n        this.hasMore = true\n      }\n      this.visibleList = list.slice(0, this.page * this.pageSize)\n      if (this.visibleList.length >= list.length) {\n        this.hasMore = false\n      }\n    },\n    loadMore() {\n      if (!this.hasMore || this.loading) return\n      if (this.visibleList.length >= this.filtered.length) return\n      this.page += 1\n      this.visibleList = this.filtered.slice(0, this.page * this.pageSize)\n      if (this.visibleList.length >= this.filtered.length) {\n        this.hasMore = false\n      }\n    },\n    goCreate() {\n      uni.navigateTo({ url: '/pages/my-customers/create' })\n    },\n    openDetail(item) {\n      uni.navigateTo({ url: `/pages/my-customers/detail?id=${item._id}` })\n    },\n    onLongPress(item) {\n      uni.showActionSheet({\n        itemList: ['Âà†Èô§ÂÆ¢Êà∑'],\n        success: () => {\n          this.confirmDelete(item)\n        }\n      })\n    },\n    confirmDelete(item) {\n      uni.showModal({\n        title: 'Âà†Èô§Á°ÆËÆ§',\n        content: `Á°ÆÂÆöÂà†Èô§„Äå${item.name}„ÄçÂêóÔºü`,\n        confirmText: 'Âà†Èô§',\n        confirmColor: '#dd524d',\n        success: res => {\n          if (res.confirm) {\n            this.deleteCustomer(item._id)\n          }\n        }\n      })\n    },\n    async deleteCustomer(id) {\n      try {\n        await deleteCustomerApi(id)\n        this.list = this.list.filter(item => item._id !== id)\n        this.applyFilter(true)\n        uni.showToast({ title: 'Â∑≤Âà†Èô§', icon: 'success' })\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || 'Âà†Èô§Â§±Ë¥•', icon: 'none' })\n      }\n    },\n    maskPhone(phone) {\n      if (!phone) return ''\n      return phone.replace(/^(\\d{3})\\d{4}(\\d{4})$/, '$1****$2')\n    },\n    toAmount(n) {\n      try {\n        return Number(n || 0).toLocaleString('zh-CN')\n      } catch (e) {\n        return n\n      }\n    }\n  }\n}\n</script>\n\n<style scoped>\n.page { min-height: 100vh; background: #f6f7f9; }\n.header {\n  background: #fff;\n  border-radius: 24px;\n  margin: 12px 12px 8px;\n  padding: 16px 16px 12px;\n  box-shadow: 0 6px 20px rgba(0,0,0,.04);\n}\n.title { font-size: 18px; color:#222; font-weight:600; margin-bottom: 12px; }\n.search {\n  height: 40px; border-radius: 20px; background:#f5f5f7;\n  display:flex; align-items:center; padding:0 12px; position:relative;\n}\n.search-icon { margin-right: 6px; color:#a3a3a9; }\n.search-input { flex:1; font-size:14px; color:#333; }\n.clear { position:absolute; right:10px; color:#b3b3b8; font-size:12px; padding:2px 6px; }\n.tabs { margin-top: 12px; white-space: nowrap; }\n.tab {\n  display:inline-flex; align-items:center; justify-content:center;\n  height:34px; padding:0 14px; margin-right:10px;\n  border-radius:17px; background:#f6f7f9; color:#666; font-size:13px;\n}\n.tab.active { background:#d9c19a; color:#fff; font-weight:600; }\n.shop-filter { margin-top:12px; white-space:nowrap; }\n.shop-pill {\n  display:inline-flex; align-items:center; justify-content:center;\n  height:30px; padding:0 12px; margin-right:8px;\n  border-radius:15px; background:#f2f2f4; color:#666; font-size:12px;\n}\n.shop-pill.active { background:#caa265; color:#fff; }\n\n.list { height: calc(100vh - 220px); padding: 0 12px 16px; box-sizing: border-box; }\n.card {\n  background:#fff; border-radius:16px; padding:12px;\n  box-shadow: 0 10px 24px rgba(0,0,0,.04);\n  margin-top: 12px;\n}\n.row-top { display:flex; align-items:center; }\n.avatar { width:48px; height:48px; border-radius:24px; background:#eee; }\n.base { flex:1; margin-left:12px; }\n.name { display:flex; align-items:center; gap:8px; font-size:16px; color:#222; font-weight:600; }\n.vip { font-size:12px; padding:2px 8px; border-radius:12px; background:#f3e7d3; color:#caa265; }\n.phone { margin-top:6px; color:#666; font-size:13px; display:flex; align-items:center; gap:6px; }\n.store { margin-top:6px; font-size:12px; color:#9a9aa0; display:flex; align-items:center; gap:4px; }\n.store-icon { color:#b7b7bc; }\n.phone-icon { color:#a9a9ad; }\n.arrow { color:#c2c2c6; font-size:22px; padding:0 4px; }\n\n.row-bottom {\n  margin-top:12px; padding-top:10px; border-top:1px solid #f1f1f3;\n  display:flex; align-items:center; justify-content:space-between;\n}\n.meta { display:flex; align-items:center; gap:6px; color:#666; font-size:13px; }\n.meta-icon { color:#b0b0b4; }\n.meta-gray { color:#9a9aa0; margin-right:4px; }\n.meta-strong { color:#333; font-weight:600; }\n.gold { color:#caa265; }\n.spend { display:flex; align-items:center; gap:6px; }\n.amount { color:#222; font-weight:700; min-width:80px; text-align:right; }\n\n.empty { text-align:center; color:#9fa1a6; padding:24px 0; }\n.loading { text-align:center; color:#a3a5ab; padding:12px 0; }\n.loading.end { color:#c0c2c7; }\n\n.fab {\n  position: fixed; right: 16px; bottom: 88px;\n  width: 52px; height: 52px; border-radius: 26px;\n  background: #caa265; color: #fff; font-size: 28px;\n  display:flex; align-items:center; justify-content:center;\n  box-shadow: 0 8px 16px rgba(0,0,0,.15); z-index: 10;\n}\n</style>\n","import MiniProgramPage from 'D:/ÁßªÂä®‰∫ëÁõòÂêåÊ≠•Áõò/hua-Â∫îÁî®/be-crm/be-crm/be-crm/pages/my-customers/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["_sfc_main","query","shops","loadShops","s","list","fetchCustomers","err","uni","item","days","value","resetPage","kw","name","phone","filterByStoreId","res","id","deleteCustomerApi","n","MiniProgramPage"],"mappings":"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"}