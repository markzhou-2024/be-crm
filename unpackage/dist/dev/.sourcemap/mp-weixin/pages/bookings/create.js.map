{"version":3,"file":"create.js","sources":["pages/bookings/create.vue","pages/bookings/create.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"page\">\n    <view class=\"header\">\n      <text class=\"title\">新增预约</text>\n      <text class=\"subtitle\">{{ customerName ? `客户：${customerName}` : '' }}</text>\n    </view>\n\n    <scroll-view class=\"form\" scroll-y>\n      <view class=\"field required\">\n        <text class=\"label\">服务/项目</text>\n        <input class=\"input\" v-model=\"form.service_name\" placeholder=\"请输入服务或项目名称\" />\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">门店</text>\n        <input class=\"input\" v-model=\"form.store_name\" placeholder=\"请输入或选择门店\" />\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">美容师/顾问</text>\n        <input class=\"input\" v-model=\"form.staff_name\" placeholder=\"可填写指定人员\" />\n      </view>\n\n      <view class=\"field datetime required\">\n        <text class=\"label\">日期</text>\n        <picker mode=\"date\" :value=\"form.date\" @change=\"onDateChange\">\n          <view class=\"picker-trigger\">{{ form.date }}</view>\n        </picker>\n      </view>\n\n      <view class=\"field datetime required\">\n        <text class=\"label\">开始时间</text>\n        <picker mode=\"time\" :value=\"form.start_time\" @change=\"e => onTimeChange('start_time', e)\">\n          <view class=\"picker-trigger\">{{ form.start_time }}</view>\n        </picker>\n      </view>\n\n      <view class=\"field datetime required\">\n        <text class=\"label\">结束时间</text>\n        <picker mode=\"time\" :value=\"form.end_time\" @change=\"e => onTimeChange('end_time', e)\">\n          <view class=\"picker-trigger\">{{ form.end_time }}</view>\n        </picker>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">备注</text>\n        <textarea class=\"textarea\" v-model=\"form.remark\" placeholder=\"可填写注意事项\" />\n      </view>\n    </scroll-view>\n\n    <view class=\"actions\">\n      <button class=\"btn ghost\" @tap=\"cancel\">取消</button>\n      <button class=\"btn primary\" :loading=\"loading\" :disabled=\"loading\" @tap=\"submit\">\n        {{ loading ? '提交中' : '保存预约' }}\n      </button>\n    </view>\n  </view>\n</template>\n\n<script>\n// @ts-nocheck\nimport { createBooking } from '@/api/bookings.js'\n\nexport default {\n  data() {\n    return {\n      customerId: '',\n      customerName: '',\n      loading: false,\n      form: {\n        service_name: '',\n        store_name: '',\n        staff_name: '',\n        date: '',\n        start_time: '',\n        end_time: '',\n        remark: ''\n      }\n    }\n  },\n  onLoad(query = {}) {\n    this.customerId = query.customer_id || ''\n    this.customerName = decodeURIComponent(query.customer_name || '')\n    if (!this.customerId) {\n      uni.showToast({ title: '缺少客户ID', icon: 'none' })\n      setTimeout(() => uni.navigateBack(), 400)\n      return\n    }\n    this.eventChannel = this.getOpenerEventChannel ? this.getOpenerEventChannel() : null\n    this.initDefaultTime()\n  },\n  methods: {\n    initDefaultTime() {\n      const now = new Date()\n      const roundedMinutes = Math.ceil(now.getMinutes() / 10) * 10\n      now.setMinutes(roundedMinutes)\n      const next = new Date(now.getTime() + 60 * 60 * 1000)\n      this.form.date = this.formatDate(now)\n      this.form.start_time = this.formatTime(now)\n      this.form.end_time = this.formatTime(next)\n    },\n    formatDate(date) {\n      const d = new Date(date)\n      const m = `${d.getMonth() + 1}`.padStart(2, '0')\n      const day = `${d.getDate()}`.padStart(2, '0')\n      return `${d.getFullYear()}-${m}-${day}`\n    },\n    formatTime(date) {\n      const d = new Date(date)\n      const hh = `${d.getHours()}`.padStart(2, '0')\n      const mm = `${d.getMinutes()}`.padStart(2, '0')\n      return `${hh}:${mm}`\n    },\n    onDateChange(e) {\n      this.form.date = e?.detail?.value || this.form.date\n    },\n    onTimeChange(key, e) {\n      const value = e?.detail?.value\n      if (key && value) {\n        this.form[key] = value\n      }\n    },\n    cancel() {\n      uni.navigateBack()\n    },\n    validate() {\n      if (!this.form.service_name.trim()) {\n        uni.showToast({ title: '请输入服务/项目', icon: 'none' })\n        return false\n      }\n      if (!this.form.store_name.trim()) {\n        uni.showToast({ title: '请输入门店', icon: 'none' })\n        return false\n      }\n      if (!this.form.date) {\n        uni.showToast({ title: '请选择日期', icon: 'none' })\n        return false\n      }\n      if (!this.form.start_time || !this.form.end_time) {\n        uni.showToast({ title: '请选择开始和结束时间', icon: 'none' })\n        return false\n      }\n      const startTs = this.combineTs(this.form.date, this.form.start_time)\n      const endTs = this.combineTs(this.form.date, this.form.end_time)\n      if (!startTs || !endTs) {\n        uni.showToast({ title: '时间选择无效', icon: 'none' })\n        return false\n      }\n      if (endTs <= startTs) {\n        uni.showToast({ title: '结束时间需晚于开始时间', icon: 'none' })\n        return false\n      }\n      this.form.start_ts = startTs\n      this.form.end_ts = endTs\n      return true\n    },\n    combineTs(dateStr, timeStr) {\n      const [year, month, day] = String(dateStr).split('-').map(num => Number(num))\n      const [hour = 0, minute = 0] = String(timeStr).split(':').map(num => Number(num))\n      if ([year, month, day].some(v => Number.isNaN(v))) return null\n      const date = new Date(year, (month || 1) - 1, day || 1, hour, minute, 0)\n      if (Number.isNaN(date.getTime())) return null\n      return date.getTime()\n    },\n    async submit() {\n      if (this.loading) return\n      if (!this.validate()) return\n      if (!this.customerId) {\n        uni.showToast({ title: '缺少客户信息', icon: 'none' })\n        return\n      }\n      this.loading = true\n      const payload = {\n        customer_id: this.customerId,\n        customer_name: this.customerName,\n        service_name: this.form.service_name.trim(),\n        store_name: this.form.store_name.trim(),\n        start_ts: this.form.start_ts,\n        end_ts: this.form.end_ts,\n        remark: this.form.remark.trim()\n      }\n      if (this.form.staff_name.trim()) {\n        payload.staff_name = this.form.staff_name.trim()\n      }\n      try {\n        await createBooking(payload)\n        uni.showToast({ title: '预约已创建', icon: 'success' })\n        this.emitCreated()\n        setTimeout(() => uni.navigateBack(), 500)\n      } catch (err) {\n        if (err?.code === 409) {\n          uni.showToast({ title: '时间段已被占用，请更换时间/人员', icon: 'none' })\n        } else if (err?.code === 401 || err?.errCode === 401) {\n          uni.showToast({ title: '登录已过期，请重新登录', icon: 'none' })\n        } else {\n          uni.showToast({ title: err?.errMsg || err?.message || '提交失败', icon: 'none' })\n        }\n      } finally {\n        this.loading = false\n      }\n    },\n    emitCreated() {\n      if (this.eventChannel) {\n        this.eventChannel.emit('bookingCreated')\n      }\n    }\n  }\n}\n</script>\n\n<style scoped>\n.page { min-height:100vh; background:#f6f7f9; display:flex; flex-direction:column; }\n.header { padding:18px 16px 8px; }\n.title { font-size:20px; font-weight:600; color:#222; }\n.subtitle { display:block; margin-top:6px; color:#9a9aa0; font-size:13px; }\n.form { flex:1; padding:8px 16px 16px; box-sizing:border-box; }\n.field { margin-bottom:14px; background:#fff; border-radius:18px; padding:12px 16px; box-shadow:0 2px 10px rgba(0,0,0,0.04); }\n.field.required .label::after { content:'*'; color:#dd524d; margin-left:4px; }\n.label { display:block; font-size:13px; color:#8f8f95; margin-bottom:8px; }\n.input { font-size:16px; color:#1c1c1e; }\n.textarea { width:100%; min-height:90px; font-size:15px; color:#1c1c1e; line-height:1.5; }\n.picker-trigger { font-size:16px; color:#1c1c1e; background:#f7f7f8; border-radius:12px; padding:10px 12px; }\n.actions { padding:16px; display:flex; gap:12px; }\n.btn { flex:1; height:46px; border-radius:26px; font-size:16px; }\n.ghost { background:#fff; color:#333; border:1px solid #eee; }\n.primary { background:#caa265; color:#fff; }\n</style>\n","import MiniProgramPage from '/Users/zhouzhongwei/Documents/HBuilderProjects/be-crm-main/pages/bookings/create.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","createBooking"],"mappings":"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"}