{"version":3,"file":"consume.js","sources":["pages/purchases/consume.vue","pages/purchases/consume.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"page\">\n    <view class=\"head\">\n      <text class=\"title\">{{ customer_name }} 消耗登记</text>\n    </view>\n\n    <view class=\"form\">\n      <view class=\"field\">\n        <text class=\"field-label\">项目名称</text>\n        <picker class=\"picker\" mode=\"selector\" :range=\"purchaseRange\" @change=\"onPurchaseChange\" :disabled=\"!purchases.length\">\n          <view class=\"picker-field\" :class=\"{ placeholder: selectedPurchaseIndex === -1 }\">\n            {{ selectedPurchaseLabel }}\n          </view>\n        </picker>\n        <view class=\"field-hint\" v-if=\"!purchases.length\">暂无购买记录，无法登记消耗</view>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"field-label\">本次消耗次数</text>\n        <view class=\"count-stepper\">\n          <button class=\"step-btn\" @tap=\"changeCount(-1)\" :disabled=\"form.count <= 1\">-</button>\n          <text class=\"count-value\">{{ form.count }}</text>\n          <button class=\"step-btn\" @tap=\"changeCount(1)\">+</button>\n        </view>\n      </view>\n\n      <view class=\"field\">\n        <text class=\"field-label\">备注</text>\n        <textarea class=\"ipt textarea\" v-model=\"form.note\" placeholder=\"可填写备注\"></textarea>\n      </view>\n\n      <button class=\"btn\" :disabled=\"!canSubmit\" @tap=\"confirmSave\">保存</button>\n    </view>\n\n    <view class=\"list\" v-if=\"records.length\">\n      <view class=\"item\" v-for=\"(r, idx) in records\" :key=\"r._id || r.id || idx\">\n        <view class=\"item-head\">\n          <text class=\"item-name\">{{ r.product_name || r.package_name || '项目' }}</text>\n          <text class=\"item-count\">{{ r.count || r.service_times || 0 }} 次</text>\n        </view>\n        <view class=\"item-sub\">\n          <text>{{ formatDate(r.consumed_at || r.service_date) }}</text>\n          <text v-if=\"r.note\" class=\"item-note\">{{ r.note }}</text>\n        </view>\n      </view>\n    </view>\n    <view v-else class=\"empty\">暂无消耗记录</view>\n  </view>\n</template>\n\n<script>\nimport { listPurchases } from '@/api/purchases.js'\n\nexport default {\n  data() {\n    return {\n      customer_id: '',\n      customer_name: '',\n      form: {\n        buy_id: '',\n        product_name: '',\n        count: 1,\n        note: ''\n      },\n      records: [],\n      purchases: [],\n      selectedPurchaseIndex: -1\n    }\n  },\n  onLoad(query = {}) {\n    this.customer_id = query.customer_id || ''\n    this.customer_name = decodeURIComponent(query.customer_name || '')\n    if (!this.customer_id) {\n      uni.showToast({ title: '缺少客户ID', icon: 'none' })\n      return\n    }\n    this.fetchRecords()\n    this.fetchPurchases()\n  },\n  onPullDownRefresh() {\n    Promise.all([this.fetchRecords(), this.fetchPurchases()]).finally(() => uni.stopPullDownRefresh())\n  },\n  computed: {\n    purchaseRange() {\n      return this.purchases.map(item => this.formatPurchaseLabel(item))\n    },\n    selectedPurchaseLabel() {\n      if (this.selectedPurchaseIndex === -1 || !this.purchases[this.selectedPurchaseIndex]) {\n        return '选择历史购买记录'\n      }\n      return this.formatPurchaseLabel(this.purchases[this.selectedPurchaseIndex])\n    },\n    canSubmit() {\n      return this.selectedPurchaseIndex !== -1 && this.form.count > 0\n    }\n  },\n  methods: {\n    getConsumeObject() {\n      return uniCloud.importObject('curd-consume', { customUI: true })\n    },\n    extractArray(payload) {\n      if (Array.isArray(payload)) return payload\n      if (Array.isArray(payload?.data)) return payload.data\n      if (Array.isArray(payload?.result?.data)) return payload.result.data\n      return []\n    },\n    formatPurchaseLabel(item = {}) {\n      const name = item.package_name || '未命名套餐'\n      const times = item.service_times ? `${item.service_times}次` : ''\n      const date = item.purchase_date || ''\n      return [name, times, date].filter(Boolean).join(' · ') || name\n    },\n    onPurchaseChange(e) {\n      const idx = Number(e?.detail?.value)\n      if (Number.isNaN(idx)) return\n      this.setSelectedPurchase(idx)\n    },\n    setSelectedPurchase(index) {\n      this.selectedPurchaseIndex = index\n      const target = this.purchases[index]\n      if (target) {\n        this.form.product_name = target.package_name || ''\n        this.form.buy_id = target._id || target.id || ''\n      } else {\n        this.form.product_name = ''\n        this.form.buy_id = ''\n      }\n    },\n    async fetchPurchases() {\n      if (!this.customer_id) return\n      try {\n        const list = await listPurchases(this.customer_id)\n        this.purchases = (list || []).sort((a, b) => {\n          const tb = Date.parse(b?.purchase_date || '') || 0\n          const ta = Date.parse(a?.purchase_date || '') || 0\n          return tb - ta\n        })\n        if (this.purchases.length) {\n          this.setSelectedPurchase(0)\n        } else {\n          this.setSelectedPurchase(-1)\n        }\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || '购买记录加载失败', icon: 'none' })\n      }\n    },\n    async fetchRecords() {\n      if (!this.customer_id) return\n      try {\n        const obj = this.getConsumeObject()\n        const res = await obj.listByCustomer({ customer_id: this.customer_id })\n        this.records = this.extractArray(res)\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || '记录加载失败', icon: 'none' })\n      }\n    },\n    confirmSave() {\n      if (!this.canSubmit) {\n        uni.showToast({ title: '请选择项目并填写次数', icon: 'none' })\n        return\n      }\n      uni.showModal({\n        title: '确认保存',\n        content: '确定要登记本次消耗吗？',\n        confirmText: '保存',\n        success: res => {\n          if (res.confirm) {\n            this.saveConsume()\n          }\n        }\n      })\n    },\n    async saveConsume() {\n      if (!this.customer_id) {\n        uni.showToast({ title: '缺少客户ID', icon: 'none' })\n        return\n      }\n      if (this.selectedPurchaseIndex === -1 || !this.form.product_name.trim()) {\n        uni.showToast({ title: '请选择项目', icon: 'none' })\n        return\n      }\n      if (!this.form.count || this.form.count <= 0) {\n        uni.showToast({ title: '消耗次数需大于0', icon: 'none' })\n        return\n      }\n      try {\n        const obj = this.getConsumeObject()\n        await obj.add({\n          customer_id: this.customer_id,\n          buy_id: this.form.buy_id,\n          product_name: this.form.product_name.trim(),\n          count: this.form.count,\n          note: this.form.note\n        })\n        uni.showToast({ title: '保存成功', icon: 'success' })\n        this.fetchRecords()\n        this.emitSavedEvent()\n        setTimeout(() => {\n          uni.navigateBack()\n        }, 400)\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || '保存失败', icon: 'none' })\n      }\n    },\n    emitSavedEvent() {\n      try {\n        const channel = this.getOpenerEventChannel && this.getOpenerEventChannel()\n        channel && channel.emit && channel.emit('consumeSaved')\n      } catch (e) {}\n    },\n    changeCount(delta) {\n      const next = Number(this.form.count || 0) + delta\n      this.form.count = Math.max(1, Math.floor(next))\n    },\n    formatDate(value) {\n      if (!value) return '--'\n      const date = typeof value === 'number' || /^\\d+$/.test(value)\n        ? new Date(Number(value))\n        : new Date(value)\n      if (Number.isNaN(date.getTime())) return '--'\n      const m = `${date.getMonth() + 1}`.padStart(2, '0')\n      const d = `${date.getDate()}`.padStart(2, '0')\n      return `${date.getFullYear()}-${m}-${d}`\n    }\n  }\n}\n</script>\n\n<style scoped>\n.page { padding:16px; background:#f6f7f9; min-height:100vh; box-sizing:border-box; }\n.head { font-size:18px; font-weight:600; margin-bottom:16px; color:#333; }\n.title { font-size:20px; }\n.form { background:#fff; border-radius:16px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.04); display:flex; flex-direction:column; gap:16px; }\n.field { display:flex; flex-direction:column; gap:6px; }\n.field-label { font-size:14px; color:#555; }\n.picker-field, .ipt { display:block; width:100%; background:#f6f7f9; border-radius:10px; padding:12px; box-sizing:border-box; border:none; font-size:14px; color:#333; }\n.picker-field.placeholder { color:#bbb; }\n.textarea { min-height:90px; }\n.ipt:focus-visible, .picker-field:focus-visible { outline:none; }\n.field-hint { font-size:12px; color:#caa265; }\n.count-stepper { display:flex; align-items:center; gap:12px; background:#f6f7f9; border-radius:10px; padding:8px 12px; }\n.step-btn { width:32px; height:32px; border-radius:16px; border:none; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.05); font-size:18px; line-height:32px; text-align:center; color:#caa265; }\n.step-btn:disabled { opacity:.4; }\n.count-value { flex:1; text-align:center; font-size:16px; font-weight:600; color:#333; }\n.btn { background:#caa265; color:#fff; border:none; padding:14px; border-radius:28px; width:100%; font-size:15px; }\n.btn:disabled { opacity:.5; }\n.list { margin-top:20px; display:flex; flex-direction:column; gap:12px; }\n.item { background:#fff; border-radius:12px; padding:12px 14px; font-size:14px; color:#333; box-shadow:0 2px 10px rgba(0,0,0,0.04); }\n.item-head { display:flex; justify-content:space-between; font-weight:600; }\n.item-count { color:#caa265; font-weight:600; }\n.item-sub { margin-top:6px; display:flex; flex-direction:column; gap:4px; font-size:12px; color:#777; }\n.item-note { color:#999; }\n.empty { color:#999; text-align:center; margin-top:24px; }\n</style>\n","import MiniProgramPage from '/Users/zhouzhongwei/Documents/HBuilderProjects/be-crm-main/pages/purchases/consume.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","uniCloud","listPurchases"],"mappings":"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"}