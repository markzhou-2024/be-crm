{"version":3,"file":"create.js","sources":["pages/purchases/create.vue","pages/purchases/create.vue?type=page"],"sourcesContent":["<template>\n  <view class=\"page\">\n    <view class=\"header\">\n      <text class=\"title\">新增购买</text>\n      <text class=\"subtitle\">{{ customerName ? `客户：${customerName}` : '' }}</text>\n    </view>\n\n    <scroll-view class=\"form\" scroll-y>\n      <view class=\"field required\">\n        <text class=\"label\">套餐名称</text>\n        <input class=\"input\" v-model=\"form.package_name\" placeholder=\"请输入套餐名称\" />\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">服务次数</text>\n        <input class=\"input\" v-model=\"form.service_times\" type=\"number\" placeholder=\"请输入正整数\" />\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">购买日期</text>\n        <picker mode=\"date\" :value=\"form.purchase_date\" @change=\"e => form.purchase_date = e.detail.value\">\n          <view class=\"picker-trigger\">{{ form.purchase_date }}</view>\n        </picker>\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">费用（元）</text>\n        <input class=\"input\" v-model=\"form.amount\" type=\"number\" placeholder=\"0.00\" />\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">备注</text>\n        <textarea class=\"textarea\" v-model=\"form.remark\" placeholder=\"可记录购买备注\" />\n      </view>\n\n      <view class=\"history\" v-if=\"history.length\">\n        <text class=\"history-title\">最近记录</text>\n        <view class=\"history-item\" v-for=\"item in history\" :key=\"item._id\">\n          <view class=\"history-row\">\n            <text class=\"history-name\">{{ item.package_name }}</text>\n            <text class=\"history-amount\">¥{{ toAmount(item.amount) }}</text>\n          </view>\n          <text class=\"history-sub\">{{ item.purchase_date }} · {{ item.service_times }} 次</text>\n        </view>\n      </view>\n    </scroll-view>\n\n    <view class=\"actions\">\n      <button class=\"btn ghost\" @tap=\"cancel\">取消</button>\n      <button class=\"btn primary\" @tap=\"submit\">保存</button>\n    </view>\n  </view>\n</template>\n\n<script>\n// @ts-nocheck\nimport { createPurchase, listPurchases } from '@/api/purchases.js'\n\nexport default {\n  data() {\n    return {\n      customerId: '',\n      customerName: '',\n      form: {\n        package_name: '',\n        service_times: '',\n        purchase_date: '',\n        amount: '',\n        remark: ''\n      },\n      history: []\n    }\n  },\n  onLoad() {\n    this.form.purchase_date = this.formatDate(new Date())\n    const channel = this.getOpenerEventChannel && this.getOpenerEventChannel()\n    if (channel) {\n      channel.on('initCustomerInfo', payload => {\n        this.customerId = payload?.customerId || ''\n        this.customerName = payload?.customerName || ''\n        this.loadHistory()\n      })\n      this.eventChannel = channel\n    }\n  },\n  methods: {\n    formatDate(date) {\n      const d = new Date(date)\n      const m = d.getMonth() + 1\n      const day = d.getDate()\n      return `${d.getFullYear()}-${m < 10 ? '0' + m : m}-${day < 10 ? '0' + day : day}`\n    },\n    async loadHistory() {\n      if (!this.customerId) return\n      try {\n        const list = await listPurchases(this.customerId)\n        this.history = list.slice(0, 5)\n      } catch (err) {\n        console.log('load history failed', err)\n      }\n    },\n    cancel() {\n      uni.navigateBack()\n    },\n    validate() {\n      if (!this.form.package_name.trim()) {\n        uni.showToast({ title: '请输入套餐名称', icon: 'none' })\n        return false\n      }\n      const times = Number(this.form.service_times)\n      if (!Number.isInteger(times) || times <= 0) {\n        uni.showToast({ title: '服务次数须为正整数', icon: 'none' })\n        return false\n      }\n      if (!this.form.purchase_date) {\n        uni.showToast({ title: '请选择购买日期', icon: 'none' })\n        return false\n      }\n      const amount = Number(this.form.amount)\n      if (isNaN(amount) || amount < 0 || !/^[0-9]+(\\.[0-9]{1,2})?$/.test(this.form.amount)) {\n        uni.showToast({ title: '费用格式不正确', icon: 'none' })\n        return false\n      }\n      this.form.service_times = times\n      this.form.amount = amount\n      return true\n    },\n    async submit() {\n      if (!this.validate()) return\n      const payload = {\n        customer_id: this.customerId,\n        package_name: this.form.package_name.trim(),\n        service_times: this.form.service_times,\n        purchase_date: this.form.purchase_date,\n        amount: this.form.amount,\n        remark: this.form.remark.trim()\n      }\n      try {\n        const record = await createPurchase(payload)\n        if (this.eventChannel) {\n          this.eventChannel.emit('purchaseCreated', record)\n        }\n        uni.navigateBack()\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || '保存失败', icon: 'none' })\n      }\n    },\n    toAmount(n) {\n      try {\n        return Number(n || 0).toLocaleString('zh-CN')\n      } catch (e) {\n        return n\n      }\n    }\n  }\n}\n</script>\n\n<style scoped>\n.page { min-height:100vh; background:#f6f7f9; display:flex; flex-direction:column; }\n.header { padding:16px; }\n.title { font-size:20px; font-weight:600; color:#222; }\n.subtitle { display:block; margin-top:4px; color:#999; font-size:12px; }\n.form { flex:1; padding:16px; box-sizing:border-box; }\n.field { margin-bottom:14px; background:#fff; border-radius:16px; padding:12px 16px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }\n.field.required .label::after { content:'*'; color:#dd524d; margin-left:4px; }\n.label { display:block; font-size:13px; color:#9a9aa0; margin-bottom:6px; }\n.input { font-size:15px; color:#333; }\n.picker-trigger { font-size:15px; color:#333; background:#f7f7f8; border-radius:10px; padding:10px 12px; }\n.textarea { width:100%; min-height:90px; font-size:15px; color:#333; }\n.history { margin-top:12px; }\n.history-title { font-size:13px; color:#999; margin-bottom:6px; }\n.history-item { background:#fff; border-radius:16px; padding:12px 14px; box-shadow:0 1px 4px rgba(0,0,0,0.04); margin-bottom:10px; }\n.history-row { display:flex; justify-content:space-between; font-size:14px; color:#333; }\n.history-amount { color:#caa265; }\n.history-sub { font-size:12px; color:#9a9aa0; margin-top:4px; }\n.actions { padding:16px; display:flex; gap:12px; }\n.btn { flex:1; height:46px; border-radius:24px; font-size:16px; }\n.primary { background:#caa265; color:#fff; }\n.ghost { background:#fff; color:#333; border:1px solid #eee; }\n</style>\n","import MiniProgramPage from '/Users/zhouzhongwei/Documents/HBuilderProjects/be-crm-main/pages/purchases/create.vue'\nwx.createPage(MiniProgramPage)"],"names":["listPurchases","uni","createPurchase"],"mappings":";;;AA0DA,MAAK,YAAU;AAAA,EACb,OAAO;AACL,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,cAAc;AAAA,MACd,MAAM;AAAA,QACJ,cAAc;AAAA,QACd,eAAe;AAAA,QACf,eAAe;AAAA,QACf,QAAQ;AAAA,QACR,QAAQ;AAAA,MACT;AAAA,MACD,SAAS,CAAC;AAAA,IACZ;AAAA,EACD;AAAA,EACD,SAAS;AACP,SAAK,KAAK,gBAAgB,KAAK,WAAW,oBAAI,MAAM;AACpD,UAAM,UAAU,KAAK,yBAAyB,KAAK,sBAAsB;AACzE,QAAI,SAAS;AACX,cAAQ,GAAG,oBAAoB,aAAW;AACxC,aAAK,cAAa,mCAAS,eAAc;AACzC,aAAK,gBAAe,mCAAS,iBAAgB;AAC7C,aAAK,YAAY;AAAA,OAClB;AACD,WAAK,eAAe;AAAA,IACtB;AAAA,EACD;AAAA,EACD,SAAS;AAAA,IACP,WAAW,MAAM;AACf,YAAM,IAAI,IAAI,KAAK,IAAI;AACvB,YAAM,IAAI,EAAE,SAAQ,IAAK;AACzB,YAAM,MAAM,EAAE,QAAQ;AACtB,aAAO,GAAG,EAAE,YAAW,CAAE,IAAI,IAAI,KAAK,MAAM,IAAI,CAAC,IAAI,MAAM,KAAK,MAAM,MAAM,GAAG;AAAA,IAChF;AAAA,IACD,MAAM,cAAc;AAClB,UAAI,CAAC,KAAK;AAAY;AACtB,UAAI;AACF,cAAM,OAAO,MAAMA,4BAAc,KAAK,UAAU;AAChD,aAAK,UAAU,KAAK,MAAM,GAAG,CAAC;AAAA,MAC9B,SAAO,KAAK;AACZC,sBAAAA,MAAY,MAAA,OAAA,oCAAA,uBAAuB,GAAG;AAAA,MACxC;AAAA,IACD;AAAA,IACD,SAAS;AACPA,oBAAAA,MAAI,aAAa;AAAA,IAClB;AAAA,IACD,WAAW;AACT,UAAI,CAAC,KAAK,KAAK,aAAa,KAAI,GAAI;AAClCA,sBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,QAAQ;AAChD,eAAO;AAAA,MACT;AACA,YAAM,QAAQ,OAAO,KAAK,KAAK,aAAa;AAC5C,UAAI,CAAC,OAAO,UAAU,KAAK,KAAK,SAAS,GAAG;AAC1CA,sBAAG,MAAC,UAAU,EAAE,OAAO,aAAa,MAAM,QAAQ;AAClD,eAAO;AAAA,MACT;AACA,UAAI,CAAC,KAAK,KAAK,eAAe;AAC5BA,sBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,QAAQ;AAChD,eAAO;AAAA,MACT;AACA,YAAM,SAAS,OAAO,KAAK,KAAK,MAAM;AACtC,UAAI,MAAM,MAAM,KAAK,SAAS,KAAK,CAAC,0BAA0B,KAAK,KAAK,KAAK,MAAM,GAAG;AACpFA,sBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,QAAQ;AAChD,eAAO;AAAA,MACT;AACA,WAAK,KAAK,gBAAgB;AAC1B,WAAK,KAAK,SAAS;AACnB,aAAO;AAAA,IACR;AAAA,IACD,MAAM,SAAS;AACb,UAAI,CAAC,KAAK,SAAQ;AAAI;AACtB,YAAM,UAAU;AAAA,QACd,aAAa,KAAK;AAAA,QAClB,cAAc,KAAK,KAAK,aAAa,KAAM;AAAA,QAC3C,eAAe,KAAK,KAAK;AAAA,QACzB,eAAe,KAAK,KAAK;AAAA,QACzB,QAAQ,KAAK,KAAK;AAAA,QAClB,QAAQ,KAAK,KAAK,OAAO,KAAK;AAAA,MAChC;AACA,UAAI;AACF,cAAM,SAAS,MAAMC,cAAc,eAAC,OAAO;AAC3C,YAAI,KAAK,cAAc;AACrB,eAAK,aAAa,KAAK,mBAAmB,MAAM;AAAA,QAClD;AACAD,sBAAAA,MAAI,aAAa;AAAA,MACjB,SAAO,KAAK;AACZA,sBAAAA,MAAI,UAAU,EAAE,QAAO,2BAAK,YAAU,2BAAK,YAAW,QAAQ,MAAM,QAAQ;AAAA,MAC9E;AAAA,IACD;AAAA,IACD,SAAS,GAAG;AACV,UAAI;AACF,eAAO,OAAO,KAAK,CAAC,EAAE,eAAe,OAAO;AAAA,MAC9C,SAAS,GAAG;AACV,eAAO;AAAA,MACT;AAAA,IACF;AAAA,EACF;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1JA,GAAG,WAAW,eAAe;"}