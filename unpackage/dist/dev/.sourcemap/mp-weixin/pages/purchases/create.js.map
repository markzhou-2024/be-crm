{"version":3,"file":"create.js","sources":["pages/purchases/create.vue","../../../../../HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHVyY2hhc2VzL2NyZWF0ZS52dWU"],"sourcesContent":["<template>\n  <view class=\"page\">\n    <view class=\"header\">\n      <text class=\"title\">新增购买</text>\n      <text class=\"subtitle\">{{ customerName ? `客户：${customerName}` : '' }}</text>\n    </view>\n\n    <scroll-view class=\"form\" scroll-y>\n      <view class=\"field required\">\n        <text class=\"label\">套餐名称</text>\n        <input class=\"input\" v-model=\"form.package_name\" placeholder=\"请输入套餐名称\" />\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">服务次数</text>\n        <input class=\"input\" v-model=\"form.service_times\" type=\"number\" placeholder=\"请输入正整数\" />\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">购买日期</text>\n        <picker mode=\"date\" :value=\"form.purchase_date\" @change=\"e => form.purchase_date = e.detail.value\">\n          <view class=\"picker-trigger\">{{ form.purchase_date }}</view>\n        </picker>\n      </view>\n\n      <view class=\"field required\">\n        <text class=\"label\">费用（元）</text>\n        <input class=\"input\" v-model=\"form.amount\" type=\"number\" placeholder=\"0.00\" />\n      </view>\n\n      <view class=\"field\">\n        <text class=\"label\">备注</text>\n        <textarea class=\"textarea\" v-model=\"form.remark\" placeholder=\"可记录购买备注\" />\n      </view>\n\n      <view class=\"history\" v-if=\"history.length\">\n        <text class=\"history-title\">最近记录</text>\n        <view class=\"history-item\" v-for=\"item in history\" :key=\"item._id\">\n          <view class=\"history-row\">\n            <text class=\"history-name\">{{ item.package_name }}</text>\n            <text class=\"history-amount\">¥{{ toAmount(item.amount) }}</text>\n          </view>\n          <text class=\"history-sub\">{{ item.purchase_date }} · {{ item.service_times }} 次</text>\n        </view>\n      </view>\n    </scroll-view>\n\n    <view class=\"actions\">\n      <button class=\"btn ghost\" @tap=\"cancel\">取消</button>\n      <button class=\"btn primary\" @tap=\"submit\">保存</button>\n    </view>\n  </view>\n</template>\n\n<script>\n// @ts-nocheck\nimport { createPurchase, listPurchases } from '@/api/purchases.js'\n\nexport default {\n  data() {\n    return {\n      customerId: '',\n      customerName: '',\n      form: {\n        package_name: '',\n        service_times: '',\n        purchase_date: '',\n        amount: '',\n        remark: ''\n      },\n      history: []\n    }\n  },\n  onLoad() {\n    this.form.purchase_date = this.formatDate(new Date())\n    const channel = this.getOpenerEventChannel && this.getOpenerEventChannel()\n    if (channel) {\n      channel.on('initCustomerInfo', payload => {\n        this.customerId = payload?.customerId || ''\n        this.customerName = payload?.customerName || ''\n        this.loadHistory()\n      })\n      this.eventChannel = channel\n    }\n  },\n  methods: {\n    formatDate(date) {\n      const d = new Date(date)\n      const m = d.getMonth() + 1\n      const day = d.getDate()\n      return `${d.getFullYear()}-${m < 10 ? '0' + m : m}-${day < 10 ? '0' + day : day}`\n    },\n    async loadHistory() {\n      if (!this.customerId) return\n      try {\n        const list = await listPurchases(this.customerId)\n        this.history = list.slice(0, 5)\n      } catch (err) {\n        console.log('load history failed', err)\n      }\n    },\n    cancel() {\n      uni.navigateBack()\n    },\n    validate() {\n      if (!this.form.package_name.trim()) {\n        uni.showToast({ title: '请输入套餐名称', icon: 'none' })\n        return false\n      }\n      const times = Number(this.form.service_times)\n      if (!Number.isInteger(times) || times <= 0) {\n        uni.showToast({ title: '服务次数须为正整数', icon: 'none' })\n        return false\n      }\n      if (!this.form.purchase_date) {\n        uni.showToast({ title: '请选择购买日期', icon: 'none' })\n        return false\n      }\n      const amount = Number(this.form.amount)\n      if (isNaN(amount) || amount < 0 || !/^[0-9]+(\\.[0-9]{1,2})?$/.test(this.form.amount)) {\n        uni.showToast({ title: '费用格式不正确', icon: 'none' })\n        return false\n      }\n      this.form.service_times = times\n      this.form.amount = amount\n      return true\n    },\n    async submit() {\n      if (!this.validate()) return\n      const payload = {\n        customer_id: this.customerId,\n        package_name: this.form.package_name.trim(),\n        service_times: this.form.service_times,\n        purchase_date: this.form.purchase_date,\n        amount: this.form.amount,\n        remark: this.form.remark.trim()\n      }\n      try {\n        const record = await createPurchase(payload)\n        if (this.eventChannel) {\n          this.eventChannel.emit('purchaseCreated', record)\n        }\n        uni.navigateBack()\n      } catch (err) {\n        uni.showToast({ title: err?.errMsg || err?.message || '保存失败', icon: 'none' })\n      }\n    },\n    toAmount(n) {\n      try {\n        return Number(n || 0).toLocaleString('zh-CN')\n      } catch (e) {\n        return n\n      }\n    }\n  }\n}\n</script>\n\n<style scoped>\n.page { min-height:100vh; background:#f6f7f9; display:flex; flex-direction:column; }\n.header { padding:16px; }\n.title { font-size:20px; font-weight:600; color:#222; }\n.subtitle { display:block; margin-top:4px; color:#999; font-size:12px; }\n.form { flex:1; padding:16px; box-sizing:border-box; }\n.field { margin-bottom:14px; background:#fff; border-radius:16px; padding:12px 16px; box-shadow:0 1px 4px rgba(0,0,0,0.04); }\n.field.required .label::after { content:'*'; color:#dd524d; margin-left:4px; }\n.label { display:block; font-size:13px; color:#9a9aa0; margin-bottom:6px; }\n.input { font-size:15px; color:#333; }\n.picker-trigger { font-size:15px; color:#333; background:#f7f7f8; border-radius:10px; padding:10px 12px; }\n.textarea { width:100%; min-height:90px; font-size:15px; color:#333; }\n.history { margin-top:12px; }\n.history-title { font-size:13px; color:#999; margin-bottom:6px; }\n.history-item { background:#fff; border-radius:16px; padding:12px 14px; box-shadow:0 1px 4px rgba(0,0,0,0.04); margin-bottom:10px; }\n.history-row { display:flex; justify-content:space-between; font-size:14px; color:#333; }\n.history-amount { color:#caa265; }\n.history-sub { font-size:12px; color:#9a9aa0; margin-top:4px; }\n.actions { padding:16px; display:flex; gap:12px; }\n.btn { flex:1; height:46px; border-radius:24px; font-size:16px; }\n.primary { background:#caa265; color:#fff; }\n.ghost { background:#fff; color:#333; border:1px solid #eee; }\n</style>\r\n","import MiniProgramPage from 'D:/移动云盘同步盘/hua-应用/be-crm/be-crm/be-crm/pages/purchases/create.vue'\nwx.createPage(MiniProgramPage)"],"names":["_sfc_main","channel","payload","date","d","m","day","list","listPurchases","err","uni","times","amount","record","createPurchase","n","MiniProgramPage"],"mappings":"2FA0DKA,EAAU,CACb,MAAO,CACL,MAAO,CACL,WAAY,GACZ,aAAc,GACd,KAAM,CACJ,aAAc,GACd,cAAe,GACf,cAAe,GACf,OAAQ,GACR,OAAQ,EACT,EACD,QAAS,CAAC,CACZ,CACD,EACD,QAAS,CACP,KAAK,KAAK,cAAgB,KAAK,WAAW,IAAI,IAAM,EACpD,MAAMC,EAAU,KAAK,uBAAyB,KAAK,sBAAsB,EACrEA,IACFA,EAAQ,GAAG,mBAAoBC,GAAW,CACxC,KAAK,YAAaA,GAAA,YAAAA,EAAS,aAAc,GACzC,KAAK,cAAeA,GAAA,YAAAA,EAAS,eAAgB,GAC7C,KAAK,YAAY,EAClB,EACD,KAAK,aAAeD,EAEvB,EACD,QAAS,CACP,WAAWE,EAAM,CACf,MAAMC,EAAI,IAAI,KAAKD,CAAI,EACjBE,EAAID,EAAE,SAAQ,EAAK,EACnBE,EAAMF,EAAE,QAAQ,EACtB,MAAO,GAAGA,EAAE,YAAW,CAAE,IAAIC,EAAI,GAAK,IAAMA,EAAIA,CAAC,IAAIC,EAAM,GAAK,IAAMA,EAAMA,CAAG,EAChF,EACD,MAAM,aAAc,CAClB,GAAK,KAAK,WACV,GAAI,CACF,MAAMC,EAAO,MAAMC,gBAAc,KAAK,UAAU,EAChD,KAAK,QAAUD,EAAK,MAAM,EAAG,CAAC,CAC9B,OAAOE,EAAK,CACZC,EAAAA,MAAY,MAAA,MAAA,mCAAA,sBAAuBD,CAAG,CACxC,CACD,EACD,QAAS,CACPC,EAAAA,MAAI,aAAa,CAClB,EACD,UAAW,CACT,GAAI,CAAC,KAAK,KAAK,aAAa,KAAI,EAC9BA,OAAAA,EAAG,MAAC,UAAU,CAAE,MAAO,UAAW,KAAM,OAAQ,EACzC,GAET,MAAMC,EAAQ,OAAO,KAAK,KAAK,aAAa,EAC5C,GAAI,CAAC,OAAO,UAAUA,CAAK,GAAKA,GAAS,EACvCD,OAAAA,EAAG,MAAC,UAAU,CAAE,MAAO,YAAa,KAAM,OAAQ,EAC3C,GAET,GAAI,CAAC,KAAK,KAAK,cACbA,OAAAA,EAAG,MAAC,UAAU,CAAE,MAAO,UAAW,KAAM,OAAQ,EACzC,GAET,MAAME,EAAS,OAAO,KAAK,KAAK,MAAM,EACtC,OAAI,MAAMA,CAAM,GAAKA,EAAS,GAAK,CAAC,0BAA0B,KAAK,KAAK,KAAK,MAAM,GACjFF,EAAG,MAAC,UAAU,CAAE,MAAO,UAAW,KAAM,OAAQ,EACzC,KAET,KAAK,KAAK,cAAgBC,EAC1B,KAAK,KAAK,OAASC,EACZ,GACR,EACD,MAAM,QAAS,CACb,GAAI,CAAC,KAAK,SAAQ,EAAI,OACtB,MAAMV,EAAU,CACd,YAAa,KAAK,WAClB,aAAc,KAAK,KAAK,aAAa,KAAM,EAC3C,cAAe,KAAK,KAAK,cACzB,cAAe,KAAK,KAAK,cACzB,OAAQ,KAAK,KAAK,OAClB,OAAQ,KAAK,KAAK,OAAO,KAAK,CAChC,EACA,GAAI,CACF,MAAMW,EAAS,MAAMC,EAAc,eAACZ,CAAO,EACvC,KAAK,cACP,KAAK,aAAa,KAAK,kBAAmBW,CAAM,EAElDH,EAAAA,MAAI,aAAa,CACjB,OAAOD,EAAK,CACZC,EAAAA,MAAI,UAAU,CAAE,OAAOD,GAAA,YAAAA,EAAK,UAAUA,GAAA,YAAAA,EAAK,UAAW,OAAQ,KAAM,OAAQ,CAC9E,CACD,EACD,SAASM,EAAG,CACV,GAAI,CACF,OAAO,OAAOA,GAAK,CAAC,EAAE,eAAe,OAAO,CAC9C,MAAY,CACV,OAAOA,CACT,CACF,CACF,CACF,wvBC1JA,GAAG,WAAWC,CAAe"}