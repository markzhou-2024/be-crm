"use strict";const e=require("../../../common/vendor.js"),l=require("../config.js"),g=e.tr.importObject("uni-id-co"),f=e.tr.database(),a=f.collection("uni-id-users");let d=e.index.getStorageSync("uni-id-pages-userInfo")||{};const p={userInfo:d,hasLogin:Object.keys(d).length!=0},_={async updateUserInfo(n=!1){if(n)a.where("_id==$env.uid").update(n).then(t=>{t.result.updated?(e.index.showToast({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(n)):e.index.showToast({title:"没有改变",icon:"none",duration:3e3})});else{const t=e.tr.importObject("uni-id-co",{customUI:!0});try{let i=await a.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();const s=await t.getRealNameInfo();this.setUserInfo({...i.result.data[0],realNameAuth:s})}catch(i){this.setUserInfo({},{cover:!0}),e.index.__f__("error","at uni_modules/uni-id-pages/common/store.js:57",i.message,i.errCode)}}},async setUserInfo(n,{cover:t}={cover:!1}){let i=t?n:Object.assign(r.userInfo,n);return r.userInfo=Object.assign({},i),r.hasLogin=Object.keys(r.userInfo).length!=0,e.index.setStorageSync("uni-id-pages-userInfo",r.userInfo),n},async logout(){if(e.tr.getCurrentUserInfo().tokenExpired>Date.now())try{await g.logout()}catch(n){e.index.__f__("error","at uni_modules/uni-id-pages/common/store.js:76",n)}e.index.removeStorageSync("uni_id_token"),e.index.setStorageSync("uni_id_token_expired",0),e.index.redirectTo({url:`/${e.pagesJson.uniIdRouter&&e.pagesJson.uniIdRouter.loginPage?e.pagesJson.uniIdRouter.loginPage:"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`}),e.index.$emit("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(n={}){const{uniIdRedirectUrl:t=""}=n;let i=0,s=getCurrentPages();if(s.forEach((o,u)=>{s[s.length-u-1].route.split("/")[3]=="login"&&i++}),t)return e.index.redirectTo({url:t,fail:o=>{e.index.switchTab({url:t,fail:u=>{e.index.__f__("log","at uni_modules/uni-id-pages/common/store.js:106",o,u)}})}});if(i){const o=e.pagesJson.pages[0];return e.index.reLaunch({url:`/${o.path}`})}e.index.navigateBack({delta:i})},loginSuccess(n={}){const{showToast:t=!0,toastText:i="登录成功",autoBack:s=!0,uniIdRedirectUrl:o="",passwordConfirmed:u}=n;if(t&&e.index.showToast({title:i,icon:"none",duration:3e3}),this.updateUserInfo(),e.index.$emit("uni-id-pages-login-success"),l.config.setPasswordAfterLogin&&!u)return e.index.redirectTo({url:o?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${o}&loginType=${n.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${n.loginType}`,fail:c=>{e.index.__f__("log","at uni_modules/uni-id-pages/common/store.js:150",c)}});s&&this.loginBack({uniIdRedirectUrl:o})}},r=e.reactive(p);exports.mutations=_;exports.store=r;
//# sourceMappingURL=../../../../.sourcemap/mp-weixin/uni_modules/uni-id-pages/common/store.js.map
