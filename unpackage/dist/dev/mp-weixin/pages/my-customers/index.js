"use strict";const s=require("../../common/vendor.js"),u=require("../../api/customers.js"),v=require("../../utils/customersStore.js"),f=require("../../utils/shopsStore.js"),d={data(){return{defaultAvatar:"https://cdn.uviewui.com/uview/album/1.jpg",keyword:"",activeTab:"all",tabs:[{label:"全部客户",value:"all"},{label:"VIP客户",value:"vip"},{label:"活跃客户",value:"active"}],shops:[],shopFilters:[],activeShopId:"",list:[],filtered:[],visibleList:[],page:1,pageSize:10,hasMore:!0,loading:!1,refreshing:!1}},onLoad(e){this.activeShopId=e&&e.store_id||"",this.initShops()},onShow(){this.initShops(),this.initData()},methods:{initShops(){const e=f.loadShops([]);this.shops=e,this.shopFilters=[{label:"全部门店",value:""},...e.map(t=>({label:t.store_name||"未命名门店",value:t._id})),{label:"未分配",value:"_unassigned"}]},async initData(){this.loading=!0;try{const e=await u.fetchCustomers();this.decorate(e),this.list=e,this.applyFilter(!0)}catch(e){s.index.showToast({title:(e==null?void 0:e.errMsg)||(e==null?void 0:e.message)||"加载失败",icon:"none"})}finally{this.loading=!1}},decorate(e){(e||[]).forEach(t=>{const r=Number(t.last_visit_days);isNaN(r)?t.last_visit_label="-":r===0?t.last_visit_label="今天":r===1?t.last_visit_label="昨天":r===7?t.last_visit_label="1周前":t.last_visit_label=`${r}天前`})},onRefresh(){this.refreshing=!0,setTimeout(()=>{this.initData(),this.refreshing=!1},400)},switchTab(e){this.activeTab=e,this.applyFilter(!0)},switchShop(e){this.activeShopId=e,this.applyFilter(!0)},clearSearch(){this.keyword="",this.applyFilter(!0)},applyFilter(e=!1){let t=this.list.slice();this.activeTab==="vip"?t=t.filter(h=>!!h.is_vip):this.activeTab==="active"&&(t=t.filter(h=>(h.last_visit_days||0)<=7));const r=(this.keyword||"").trim();r&&(t=t.filter(h=>{const l=h.name||"",a=h.phone||"";return l.indexOf(r)>=0||a.indexOf(r)>=0})),t=v.filterByStoreId(t,this.activeShopId),this.filtered=t,e&&(this.page=1,this.hasMore=!0),this.visibleList=t.slice(0,this.page*this.pageSize),this.visibleList.length>=t.length&&(this.hasMore=!1)},loadMore(){!this.hasMore||this.loading||this.visibleList.length>=this.filtered.length||(this.page+=1,this.visibleList=this.filtered.slice(0,this.page*this.pageSize),this.visibleList.length>=this.filtered.length&&(this.hasMore=!1))},goCreate(){s.index.navigateTo({url:"/pages/my-customers/create"})},openDetail(e){s.index.navigateTo({url:`/pages/my-customers/detail?id=${e._id}`})},onLongPress(e){s.index.showActionSheet({itemList:["删除客户"],success:()=>{this.confirmDelete(e)}})},confirmDelete(e){s.index.showModal({title:"删除确认",content:`确定删除「${e.name}」吗？`,confirmText:"删除",confirmColor:"#dd524d",success:t=>{t.confirm&&this.deleteCustomer(e._id)}})},async deleteCustomer(e){try{await u.deleteCustomer(e),this.list=this.list.filter(t=>t._id!==e),this.applyFilter(!0),s.index.showToast({title:"已删除",icon:"success"})}catch(t){s.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"删除失败",icon:"none"})}},maskPhone(e){return e?e.replace(/^(\d{3})\d{4}(\d{4})$/,"$1****$2"):""},toAmount(e){try{return Number(e||0).toLocaleString("zh-CN")}catch{return e}}}};function g(e,t,r,h,l,a){return s.e({a:s.o(i=>a.applyFilter(!0)),b:l.keyword,c:s.o(i=>l.keyword=i.detail.value),d:l.keyword},l.keyword?{e:s.o((...i)=>a.clearSearch&&a.clearSearch(...i))}:{},{f:s.f(l.tabs,(i,n,c)=>({a:s.t(i.label),b:i.value,c:l.activeTab===i.value?1:"",d:s.o(o=>a.switchTab(i.value),i.value)})),g:s.f(l.shopFilters,(i,n,c)=>({a:s.t(i.label),b:i.value,c:l.activeShopId===i.value?1:"",d:s.o(o=>a.switchShop(i.value),i.value)})),h:s.f(l.visibleList,(i,n,c)=>s.e({a:i.avatar||l.defaultAvatar,b:s.t(i.name),c:i.is_vip},i.is_vip?{}:{},{d:s.t(a.maskPhone(i.phone)),e:i.store_name},i.store_name?{f:s.t(i.store_name)}:{},{g:s.t(i.last_visit_label||"-"),h:s.t(a.toAmount(i.total_spend)),i:s.o(o=>a.openDetail(i),i._id),j:s.o(o=>a.onLongPress(i),i._id),k:i._id})),i:!l.visibleList.length&&!l.loading&&!l.refreshing},!l.visibleList.length&&!l.loading&&!l.refreshing?{}:{},{j:l.loading},l.loading?{}:!l.hasMore&&l.visibleList.length?{}:{},{k:!l.hasMore&&l.visibleList.length,l:s.o((...i)=>a.loadMore&&a.loadMore(...i)),m:l.refreshing,n:s.o((...i)=>a.onRefresh&&a.onRefresh(...i)),o:s.o((...i)=>a.goCreate&&a.goCreate(...i))})}const _=s._export_sfc(d,[["render",g],["__scopeId","data-v-6c36fae8"]]);wx.createPage(_);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/my-customers/index.js.map
