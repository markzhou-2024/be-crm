"use strict";const e=require("../../common/vendor.js"),c=require("../../api/customers.js"),u=require("../../api/purchases.js"),l={data(){return{id:"",customer:{},notesDraft:"",defaultAvatar:"https://cdn.uviewui.com/uview/album/1.jpg",tabs:[{label:"购买",value:"purchase"},{label:"消耗",value:"consume"},{label:"预约",value:"booking"},{label:"图库",value:"gallery"},{label:"备注",value:"notes"}],activeTab:"purchase",purchaseHistory:[]}},onLoad(t){if(this.id=t&&t.id||"",!this.id){e.index.showToast({title:"缺少客户ID",icon:"none"}),setTimeout(()=>e.index.navigateBack(),400);return}this.loadData()},onShow(){this.id&&this.loadData()},methods:{async loadData(){try{const t=await c.getCustomerById(this.id);if(!t){e.index.showToast({title:"客户不存在",icon:"none"}),setTimeout(()=>e.index.navigateBack(),400);return}this.customer=t,this.notesDraft=t.notes||"",e.index.setNavigationBarTitle({title:t.name||"客户详情"}),this.loadPurchaseHistory()}catch(t){e.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"加载失败",icon:"none"})}},async loadPurchaseHistory(){try{const t=await u.listPurchases(this.id);this.purchaseHistory=t}catch(t){e.index.__f__("log","at pages/my-customers/detail.vue:140","load purchase failed",t),this.purchaseHistory=[]}},goEdit(){e.index.navigateTo({url:`/pages/my-customers/edit?id=${this.id}`})},goPurchase(){e.index.navigateTo({url:"/pages/purchases/create",events:{purchaseCreated:()=>{this.loadPurchaseHistory(),e.index.showToast({title:"已记录购买",icon:"success"})}},success:t=>{t.eventChannel.emit("initCustomerInfo",{customerId:this.id,customerName:this.customer.name})}})},comingSoon(t){e.index.showToast({title:`${t}功能开发中`,icon:"none"})},async saveNotes(){try{await c.updateCustomer({_id:this.id,notes:this.notesDraft}),this.customer.notes=this.notesDraft,e.index.showToast({title:"备注已保存",icon:"success"})}catch(t){e.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"保存失败",icon:"none"})}},confirmDelete(){e.index.showModal({title:"删除客户",content:"删除后不可恢复，确定删除？",confirmText:"删除",confirmColor:"#dd524d",success:t=>{t.confirm&&this.deleteCustomer()}})},async deleteCustomer(){try{await c.deleteCustomer(this.id),e.index.showToast({title:"已删除",icon:"success"}),setTimeout(()=>e.index.navigateBack(),400)}catch(t){e.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"删除失败",icon:"none"})}},toAmount(t){try{return Number(t||0).toLocaleString("zh-CN")}catch{return t}}}};function m(t,r,v,g,s,i){return e.e({a:e.o((...o)=>i.goEdit&&i.goEdit(...o)),b:s.customer.avatar||s.defaultAvatar,c:e.t(s.customer.name),d:s.customer.is_vip},s.customer.is_vip?{}:{},{e:s.customer.store_name},s.customer.store_name?{f:e.t(s.customer.store_name)}:{},{g:s.customer.tags},s.customer.tags?{h:e.t(s.customer.tags)}:{},{i:s.customer.city},s.customer.city?{j:e.t(s.customer.city)}:{},{k:e.t(s.customer.phone||"-"),l:e.t(i.toAmount(s.customer.total_spend)),m:e.t(s.customer.visit_count||0),n:e.f(s.tabs,(o,a,n)=>({a:e.t(o.label),b:o.value,c:s.activeTab===o.value?1:"",d:e.o(d=>s.activeTab=o.value,o.value)})),o:s.activeTab==="purchase"},s.activeTab==="purchase"?e.e({p:s.purchaseHistory.length},s.purchaseHistory.length?{q:e.f(s.purchaseHistory,(o,a,n)=>e.e({a:e.t(o.package_name),b:e.t(i.toAmount(o.amount)),c:e.t(o.purchase_date),d:e.t(o.service_times),e:o.remark},o.remark?{f:e.t(o.remark)}:{},{g:o._id}))}:{}):s.activeTab==="consume"?{}:s.activeTab==="booking"?{}:s.activeTab==="gallery"?{}:{v:s.notesDraft,w:e.o(o=>s.notesDraft=o.detail.value),x:e.o((...o)=>i.saveNotes&&i.saveNotes(...o))},{r:s.activeTab==="consume",s:s.activeTab==="booking",t:s.activeTab==="gallery",y:e.o((...o)=>i.goPurchase&&i.goPurchase(...o)),z:e.o(o=>i.comingSoon("消耗")),A:e.o(o=>i.comingSoon("预约")),B:e.o((...o)=>i.confirmDelete&&i.confirmDelete(...o))})}const h=e._export_sfc(l,[["render",m],["__scopeId","data-v-20dde889"]]);wx.createPage(h);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/my-customers/detail.js.map
