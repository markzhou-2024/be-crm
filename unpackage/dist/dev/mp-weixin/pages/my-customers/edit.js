"use strict";const e=require("../../common/vendor.js"),r=require("../../api/customers.js"),m=require("../../api/shops.js"),h={data(){return{id:"",submitting:!1,shopOptions:[],form:{_id:"",name:"",phone:"",is_vip:!1,avatar:"",tags:"",city:"",notes:"",store_id:"",store_name:""}}},async onLoad(t){if(this.id=t&&t.id||"",!this.id){e.index.showToast({title:"缺少客户ID",icon:"none"}),setTimeout(()=>e.index.navigateBack(),400);return}await this.initShops(),this.loadData()},methods:{async initShops(){try{const t=await m.fetchShops();this.shopOptions=t.map(s=>({value:s._id,label:s.store_name||"未命名门店"}))}catch(t){e.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"加载门店失败",icon:"none"}),this.shopOptions=[]}},async loadData(){try{const t=await r.getCustomerById(this.id);if(!t){e.index.showToast({title:"客户不存在",icon:"none"}),setTimeout(()=>e.index.navigateBack(),400);return}if(!t.store_name&&t.store_id){const s=this.shopOptions.find(n=>n.value===t.store_id);s&&(t.store_name=s.label)}this.form={...t}}catch(t){e.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"加载失败",icon:"none"})}},onVipChange(t){this.form.is_vip=!!t.detail.value},onPickShop(t){const s=Number(t.detail.value),n=this.shopOptions[s];n&&(this.form.store_id=n.value,this.form.store_name=n.label)},validate(){const t=(this.form.name||"").trim(),s=(this.form.phone||"").trim();return t?s&&!/^1\d{10}$/.test(s)?(e.index.showToast({title:"手机号格式错误",icon:"none"}),!1):this.form.store_id?(this.form.name=t,this.form.phone=s,!0):(e.index.showToast({title:"请选择归属门店",icon:"none"}),!1):(e.index.showToast({title:"请填写姓名",icon:"none"}),!1)},async submit(){if(!this.submitting&&this.validate()){this.submitting=!0;try{await r.updateCustomer(this.form),e.index.showToast({title:"保存成功",icon:"success"}),setTimeout(()=>e.index.navigateBack(),400)}catch(t){e.index.showToast({title:(t==null?void 0:t.errMsg)||(t==null?void 0:t.message)||"保存失败",icon:"none"})}finally{this.submitting=!1}}}}};function c(t,s,n,l,o,a){return{a:o.form.name,b:e.o(i=>o.form.name=i.detail.value),c:o.form.phone,d:e.o(i=>o.form.phone=i.detail.value),e:o.form.is_vip,f:e.o((...i)=>a.onVipChange&&a.onVipChange(...i)),g:e.t(o.form.store_name||"请选择门店"),h:o.shopOptions,i:e.o((...i)=>a.onPickShop&&a.onPickShop(...i)),j:o.form.avatar,k:e.o(i=>o.form.avatar=i.detail.value),l:o.form.tags,m:e.o(i=>o.form.tags=i.detail.value),n:o.form.city,o:e.o(i=>o.form.city=i.detail.value),p:o.form.notes,q:e.o(i=>o.form.notes=i.detail.value),r:o.submitting,s:e.o((...i)=>a.submit&&a.submit(...i))}}const f=e._export_sfc(h,[["render",c],["__scopeId","data-v-edda8338"]]);wx.createPage(f);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/my-customers/edit.js.map
