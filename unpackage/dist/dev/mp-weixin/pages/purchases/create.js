"use strict";const t=require("../../common/vendor.js"),c=require("../../api/purchases.js"),m={data(){return{customerId:"",customerName:"",form:{package_name:"",service_times:"",purchase_date:"",amount:"",remark:""},history:[]}},onLoad(){this.form.purchase_date=this.formatDate(new Date);const r=this.getOpenerEventChannel&&this.getOpenerEventChannel();r&&(r.on("initCustomerInfo",e=>{this.customerId=(e==null?void 0:e.customerId)||"",this.customerName=(e==null?void 0:e.customerName)||"",this.loadHistory()}),this.eventChannel=r)},methods:{formatDate(r){const e=new Date(r),o=e.getMonth()+1,a=e.getDate();return`${e.getFullYear()}-${o<10?"0"+o:o}-${a<10?"0"+a:a}`},async loadHistory(){if(this.customerId)try{const r=await c.listPurchases(this.customerId);this.history=r.slice(0,5)}catch(r){t.index.__f__("log","at pages/purchases/create.vue:99","load history failed",r)}},cancel(){t.index.navigateBack()},validate(){if(!this.form.package_name.trim())return t.index.showToast({title:"请输入套餐名称",icon:"none"}),!1;const r=Number(this.form.service_times);if(!Number.isInteger(r)||r<=0)return t.index.showToast({title:"服务次数须为正整数",icon:"none"}),!1;if(!this.form.purchase_date)return t.index.showToast({title:"请选择购买日期",icon:"none"}),!1;const e=Number(this.form.amount);return isNaN(e)||e<0||!/^[0-9]+(\.[0-9]{1,2})?$/.test(this.form.amount)?(t.index.showToast({title:"费用格式不正确",icon:"none"}),!1):(this.form.service_times=r,this.form.amount=e,!0)},async submit(){if(!this.validate())return;const r={customer_id:this.customerId,package_name:this.form.package_name.trim(),service_times:this.form.service_times,purchase_date:this.form.purchase_date,amount:this.form.amount,remark:this.form.remark.trim()};try{const e=await c.createPurchase(r);this.eventChannel&&this.eventChannel.emit("purchaseCreated",e),t.index.navigateBack()}catch(e){t.index.showToast({title:(e==null?void 0:e.errMsg)||(e==null?void 0:e.message)||"保存失败",icon:"none"})}},toAmount(r){try{return Number(r||0).toLocaleString("zh-CN")}catch{return r}}}};function u(r,e,o,a,i,n){return t.e({a:t.t(i.customerName?`客户：${i.customerName}`:""),b:i.form.package_name,c:t.o(s=>i.form.package_name=s.detail.value),d:i.form.service_times,e:t.o(s=>i.form.service_times=s.detail.value),f:t.t(i.form.purchase_date),g:i.form.purchase_date,h:t.o(s=>i.form.purchase_date=s.detail.value),i:i.form.amount,j:t.o(s=>i.form.amount=s.detail.value),k:i.form.remark,l:t.o(s=>i.form.remark=s.detail.value),m:i.history.length},i.history.length?{n:t.f(i.history,(s,f,_)=>({a:t.t(s.package_name),b:t.t(n.toAmount(s.amount)),c:t.t(s.purchase_date),d:t.t(s.service_times),e:s._id}))}:{},{o:t.o((...s)=>n.cancel&&n.cancel(...s)),p:t.o((...s)=>n.submit&&n.submit(...s))})}const h=t._export_sfc(m,[["render",u],["__scopeId","data-v-367e90ab"]]);wx.createPage(h);
//# sourceMappingURL=../../../.sourcemap/mp-weixin/pages/purchases/create.js.map
